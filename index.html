<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Survey Traverse Plotter</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;500;600;700;800&family=Share+Tech+Mono&display=swap');
:root{
  --bg:#f5f0e8;--surface:#fffdf8;--surface2:#ede8dc;--border:#c8bfaa;
  --accent:#1a4a2e;--accent2:#c17f24;--accent3:#8b2e2e;
  --text:#1c1a16;--text-dim:#7a7060;--text-light:#b0a898;--r:10px;
  --snap:#e67e22;--toolbar:#1e1e1e;--toolbarbg:#252525;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Oxanium',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{background:var(--accent);color:#fff;padding:11px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.22);}
.logo{font-size:20px;font-weight:800;letter-spacing:2px;text-transform:uppercase;}
.sub{font-size:10px;opacity:.5;font-family:'Share Tech Mono',monospace;letter-spacing:1px;}
.tabs{display:flex;background:var(--surface2);border-bottom:2px solid var(--border);padding:0 16px;gap:2px;flex-shrink:0;}
.tab-btn{font-family:'Oxanium',sans-serif;font-weight:600;font-size:13px;padding:11px 20px;border:none;background:transparent;cursor:pointer;color:var(--text-dim);letter-spacing:.6px;text-transform:uppercase;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .18s;}
.tab-btn:hover{color:var(--accent);}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--surface);border-radius:7px 7px 0 0;}
.main{flex:1;display:flex;overflow:hidden;min-height:0;}
.panel{display:none;width:100%;height:100%;}
.panel.active{display:flex;}

/* INPUT TAB */
#tab-input{flex-direction:row;overflow:hidden;}
.input-pane{width:52%;min-width:360px;max-width:720px;display:flex;flex-direction:column;background:var(--bg);border-right:2px solid var(--border);overflow:hidden;}
.input-pane-top{flex-shrink:0;padding:14px 16px 0;display:flex;flex-direction:column;gap:12px;}
.input-pane-table{flex:1;min-height:0;padding:0 16px 14px;display:flex;flex-direction:column;gap:8px;overflow:hidden;}
.plot-pane{flex:1;position:relative;overflow:hidden;background:#eee9de;display:flex;flex-direction:column;}
.plot-pane-header{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.plot-pane-title{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);}
.live-canvas-wrap{flex:1;position:relative;overflow:hidden;}
#live-canvas{display:block;}
.plot-pane-info{position:absolute;bottom:8px;left:8px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);background:rgba(255,253,248,.92);padding:5px 9px;border-radius:5px;border:1px solid var(--border);pointer-events:none;}
.resizer{width:5px;background:var(--border);cursor:col-resize;flex-shrink:0;transition:background .15s;}
.resizer:hover,.resizer.dragging{background:var(--accent);}
.card{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:14px;}
.section-title{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:7px;}
textarea#raw-input{width:100%;min-height:100px;font-family:'Share Tech Mono',monospace;font-size:12px;border:none;background:transparent;resize:vertical;color:var(--text);outline:none;line-height:1.85;}
.btn-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;align-items:center;}
.btn{font-family:'Oxanium',sans-serif;font-weight:600;font-size:12px;padding:8px 14px;border:none;border-radius:7px;cursor:pointer;letter-spacing:.3px;transition:all .16s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover:not(:disabled){background:#0f3320;transform:translateY(-1px);box-shadow:0 3px 10px rgba(26,74,46,.35);}
.btn-secondary{background:var(--surface2);color:var(--text);border:2px solid var(--border);}
.btn-secondary:hover:not(:disabled){border-color:var(--accent);color:var(--accent);}
.btn-warning{background:var(--accent2);color:#fff;}
.btn-warning:hover:not(:disabled){background:#a06a1a;}
.btn-danger{background:var(--accent3);color:#fff;}
.btn-danger:hover:not(:disabled){background:#701f1f;}
.btn-sm{font-size:11px;padding:6px 11px;}
.btn-icon{font-size:12px;padding:6px 9px;min-width:30px;justify-content:center;}
.divider{width:1px;height:24px;background:var(--border);margin:0 1px;flex-shrink:0;}
.undo-bar{display:flex;gap:4px;align-items:center;}
.undo-label{font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;white-space:nowrap;}
.table-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:8px;flex-shrink:0;}
.data-table-wrap{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);overflow-y:auto;flex:1;min-height:0;}
.data-table{width:100%;border-collapse:collapse;font-family:'Share Tech Mono',monospace;font-size:11px;}
.data-table th{background:var(--accent);color:#fff;font-family:'Oxanium',sans-serif;font-size:9px;letter-spacing:1.2px;text-transform:uppercase;padding:10px 8px;text-align:left;position:sticky;top:0;z-index:1;}
.data-table th.sel-col{width:28px;text-align:center;}
.data-table td{padding:7px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.data-table tr:last-child td{border-bottom:none;}
.data-table tr.selected td{background:#d4edda!important;}
.data-table tr:hover:not(.selected) td{background:var(--surface2);}
.data-table tr.drag-over td{background:#b8dfc9;border-top:2px solid var(--accent);}
.drag-handle{color:var(--text-light);cursor:grab;font-size:14px;user-select:none;}
.row-check{width:13px;height:13px;cursor:pointer;accent-color:var(--accent);}
.inline-edit{font-family:'Share Tech Mono',monospace;font-size:11px;border:1px solid var(--border);border-radius:3px;padding:3px 5px;background:var(--bg);color:var(--text);width:100%;outline:none;}
.inline-edit:focus{border-color:var(--accent);background:#fff;}
select.inline-edit{cursor:pointer;}

/* â•â•â• FOOTER â•â•â• */
footer{background:var(--accent);color:#fff;padding:10px 20px;text-align:center;font-size:11px;flex-shrink:0;box-shadow:0 -2px 8px rgba(0,0,0,.15);}
.trademark{font-family:'Share Tech Mono',monospace;letter-spacing:1px;opacity:.9;}

/* â•â•â• EXPORT TAB â•â•â• */
#tab-export{flex-direction:column;overflow:hidden;}

/* Dark toolbar across top */
.exp-toolbar{
  flex-shrink:0;height:52px;
  background:var(--toolbarbg);
  display:flex;align-items:center;
  gap:0;padding:0 10px;
  border-bottom:2px solid #111;
  overflow-x:auto;
  scrollbar-width:none;
}
.exp-toolbar::-webkit-scrollbar{display:none;}
.tb-group{display:flex;align-items:center;gap:3px;padding:0 10px;height:100%;}
.tb-group:last-child{border-right:none;}
.tb-label{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#555;margin-right:4px;white-space:nowrap;}
.tb-btn{
  display:flex;align-items:center;gap:5px;
  font-family:'Oxanium',sans-serif;font-size:11px;font-weight:600;
  color:#aaa;padding:5px 10px;border:1.5px solid transparent;border-radius:6px;
  background:transparent;cursor:pointer;transition:all .13s;white-space:nowrap;
  height:34px;
}
.tb-btn:hover:not(:disabled){background:#333;color:#fff;border-color:#444;}
.tb-btn.active{background:#1a3a23;color:#4caf7d;border-color:#2d6b3f;box-shadow:0 0 0 1px rgba(77,175,125,.2);}
.tb-btn:disabled{opacity:.28;cursor:not-allowed;}
.tb-sep{width:1px;background:#333;margin:0 4px;flex-shrink:0;}
.tb-btn-export{background:rgba(26,74,46,.5);color:#7dd9a0;border-color:#2d5c3a;}
.tb-btn-export:hover{background:#0f3320!important;color:#a0f0c0!important;}

/* Toolbar inline selects (like the line-style select) should remain readable */
#tb-line-style, #tool-line select {
  color: #000 !important;
  background: #fff !important;
  border: 1px solid rgba(0,0,0,0.08) !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}
#tb-line-style option{ color:#000 !important; background:#fff !important; }

/* Body split */
.exp-body{flex:1;display:flex;min-height:0;overflow:hidden;}

/* Sidebar â€” accordion panels */
.exp-sidebar{
  width:260px;min-width:220px;flex-shrink:0;
  background:var(--surface);border-right:2px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
}
.sidebar-scroll{flex:1;overflow-y:auto;display:flex;flex-direction:column;}

.acc{border-bottom:1px solid var(--border);}
.acc-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 13px;cursor:pointer;user-select:none;
  background:var(--surface);transition:background .14s;
  flex-shrink:0;
}
.acc-hdr:hover{background:var(--surface2);}
.acc-hdr-left{display:flex;align-items:center;gap:8px;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);}
.acc-hdr-icon{font-size:14px;}
.acc-arrow{font-size:9px;color:var(--text-light);transition:transform .2s;}
.acc.open .acc-arrow{transform:rotate(180deg);}
.acc-body{display:none;padding:11px 13px;background:var(--bg);flex-direction:column;gap:9px;}
.acc.open .acc-body{display:flex;}

/* Controls */
.cr{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.cl{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;flex-shrink:0;}
.cv{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);min-width:24px;text-align:right;}
input[type=range]{-webkit-appearance:none;flex:1;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;}
input[type=number]{font-family:'Share Tech Mono',monospace;font-size:11px;width:62px;padding:5px 6px;border:1px solid var(--border);border-radius:5px;background:var(--surface);color:var(--text);text-align:center;}
input[type=color]{width:30px;height:26px;border:2px solid var(--border);border-radius:5px;cursor:pointer;background:none;padding:2px;}
.ctrl-select{font-family:'Oxanium',sans-serif;font-size:11px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;background:var(--surface);color:var(--text);cursor:pointer;outline:none;width:100%;}
.toggle-row{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;}
.toggle{position:relative;width:34px;height:19px;background:var(--border);border-radius:10px;transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;width:13px;height:13px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.toggle.on::after{transform:translateX(15px);}

/* Tool props strip â€” shown under toolbar */
.tool-props-strip{
  flex-shrink:0;background:var(--toolbarbg);
  border-bottom:1px solid #1a1a1a;
  padding:6px 14px;display:none;
  align-items:center;gap:14px;
  font-size:11px;color:#aaa;
  font-family:'Oxanium',sans-serif;
}
.tool-props-strip.visible{display:flex;}
.tp-label{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#666;white-space:nowrap;}
.tp-val{display:flex;align-items:center;gap:5px;}
.tp-input{background:#2a2a2a;border:1px solid #444;border-radius:4px;color:#ddd;font-size:11px;padding:3px 6px;outline:none;font-family:'Share Tech Mono',monospace;}
.tp-input:focus{border-color:var(--accent);}
select.tp-input{cursor:pointer;font-family:'Oxanium',sans-serif;}

/* Canvas area */
.exp-canvas-area{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
.exp-canvas-wrap{flex:1;position:relative;overflow:hidden;background:repeating-conic-gradient(#d5d0c5 0% 25%,#e0dbd0 0% 50%) 0 0/18px 18px;}
#export-canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);box-shadow:0 6px 40px rgba(0,0,0,.3);}
.canvas-status{
  flex-shrink:0;height:24px;background:#1a1a1a;
  display:flex;align-items:center;gap:16px;
  padding:0 14px;font-family:'Share Tech Mono',monospace;font-size:10px;color:#555;
}
.cs-item{display:flex;align-items:center;gap:5px;}
.cs-snap{color:var(--snap)!important;font-weight:700;}

/* Text input floating overlay on canvas */
#txt-overlay{
  display:none;position:fixed;z-index:9999;
  background:rgba(255,253,248,.97);border:2px solid var(--accent);
  border-radius:6px;padding:5px 9px;
  font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--text);
  outline:none;min-width:100px;box-shadow:0 4px 16px rgba(0,0,0,.18);
}

/* Snap indicator dot */
.snap-ring{
  position:fixed;width:12px;height:12px;border-radius:50%;
  border:2px solid var(--snap);background:rgba(230,126,34,.25);
  transform:translate(-50%,-50%);pointer-events:none;display:none;z-index:999;
}

/* Preview modal */
.preview-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.88);flex-direction:column;align-items:center;justify-content:center;}
.preview-modal.open{display:flex;}
.preview-bar{position:absolute;top:0;left:0;right:0;background:rgba(26,74,46,.97);padding:10px 20px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 12px rgba(0,0,0,.4);}
.preview-title{color:#fff;font-weight:700;font-size:14px;letter-spacing:1px;flex:1;}
.preview-bg{margin-top:44px;flex:1;width:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:repeating-conic-gradient(#2a2a2a 0% 25%,#1e1e1e 0% 50%) 0 0/20px 20px;}
#preview-canvas{max-width:95vw;max-height:calc(95vh - 60px);box-shadow:0 0 60px rgba(255,255,255,.07);}

.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--accent);color:#fff;padding:10px 22px;border-radius:7px;font-weight:600;font-size:13px;z-index:19999;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 4px 18px rgba(0,0,0,.2);pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}

/* small full-width action button */
.full-btn{width:100%;justify-content:center;margin-top:2px;}

/* Drawing sub-sections */
.draw-section{
  background:var(--surface);border:1px solid var(--border);border-radius:7px;
  padding:9px 10px;display:flex;flex-direction:column;gap:7px;
}
.draw-section-title{
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--accent);margin-bottom:2px;border-bottom:1px solid var(--border);padding-bottom:5px;
}

/* â”€â”€ SHORTCUT EDITOR MODAL â”€â”€ */
.sc-modal{
  display:none;position:fixed;inset:0;z-index:11000;
  background:rgba(0,0,0,.72);
  align-items:center;justify-content:center;
}
.sc-modal.open{display:flex;}
.sc-panel{
  background:var(--surface);border:2px solid var(--border);border-radius:14px;
  width:360px;max-width:95vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
  display:flex;flex-direction:column;overflow:hidden;
}
.sc-header{
  background:var(--accent);color:#fff;padding:14px 18px;
  display:flex;align-items:center;justify-content:space-between;
}
.sc-title{font-size:14px;font-weight:800;letter-spacing:1px;}
.sc-close{background:none;border:none;color:rgba(255,255,255,.7);font-size:18px;cursor:pointer;padding:2px 6px;border-radius:4px;}
.sc-close:hover{color:#fff;background:rgba(255,255,255,.15);}
.sc-body{padding:16px;display:flex;flex-direction:column;gap:10px;}
.sc-row{
  display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;
  padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;
}
.sc-tool-name{font-size:12px;font-weight:600;color:var(--text);}
.sc-tool-desc{font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;}
.sc-key-btn{
  font-family:'Share Tech Mono',monospace;font-size:12px;font-weight:700;
  background:var(--surface2);border:2px solid var(--border);border-radius:5px;
  color:var(--accent);padding:4px 10px;min-width:36px;text-align:center;
  cursor:pointer;transition:all .14s;user-select:none;
}
.sc-key-btn:hover{border-color:var(--accent);background:var(--accent);color:#fff;}
.sc-key-btn.listening{
  border-color:var(--accent2);background:var(--accent2);color:#fff;
  animation:pulse-btn .8s infinite alternate;
}
@keyframes pulse-btn{from{opacity:.7;}to{opacity:1;}}
.sc-footer{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}

/* â”€â”€ TEXT ROTATION HANDLE â”€â”€ */
/* Drawn purely on canvas â€” no extra DOM needed */
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">âŠ¹ Traverse Plotter</div>
    <div class="sub">SURVEY DATA VISUALIZATION TOOL</div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('input')">ğŸ“‹ Data &amp; Plot</button>
  <button class="tab-btn" onclick="switchTab('export')">âœï¸ Export &amp; Edit</button>
</div>

<div class="main">

<!-- â•â• TAB 1 â•â• -->
<div class="panel active" id="tab-input">
  <div class="input-pane" id="input-pane">
    <div class="input-pane-top">
      <div class="card">
        <div class="section-title">ğŸ“¥ Paste Survey Data</div>
        <div style="font-size:9px;color:var(--text-dim);margin-bottom:7px;font-family:'Share Tech Mono',monospace;line-height:1.85;">
          Format: <b>FROM-TO  N/S  DEG  MIN  [SEC]  E/W  DIST</b> â€” tab or space separated
        </div>
        <textarea id="raw-input" placeholder="1-2&#9;S 75 38 E&#9;8.58&#10;2-3&#9;S 14 27 W&#9;14.18&#10;..."></textarea>
        <div class="btn-row">
          <button class="btn btn-primary btn-sm" onclick="parseAndLoad()">âŸµ Parse &amp; Load</button>
          <button class="btn btn-secondary btn-sm" onclick="pasteFromClipboard()">ğŸ“‹ Clipboard</button>
          <button class="btn btn-secondary btn-sm" onclick="clearAll()">âœ• Clear</button>
          <button class="btn btn-secondary btn-sm" onclick="loadSampleData()">â—· Sample</button>
          <div class="divider"></div>
          <div class="undo-bar">
            <span class="undo-label">Paste:</span>
            <button class="btn btn-secondary btn-icon" id="paste-undo-btn" onclick="pasteUndo()">â†©</button>
            <button class="btn btn-secondary btn-icon" id="paste-redo-btn" onclick="pasteRedo()">â†ª</button>
          </div>
          <div class="divider"></div>
          <div class="undo-bar">
            <span class="undo-label">Size:</span>
            <button class="btn btn-secondary btn-icon" onclick="zoomTextarea(1.1)" title="Zoom in">ï¼‹</button>
            <button class="btn btn-secondary btn-icon" onclick="zoomTextarea(0.91)" title="Zoom out">ï¼</button>
            <span style="font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;margin-left:2px;" id="textarea-zoom-level">100%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="input-pane-table">
      <div class="table-header">
        <div class="section-title" style="margin:0;">ğŸ“Š Survey Lines &nbsp;<span id="row-count" style="color:var(--accent2);font-size:9px;"></span></div>
        <div class="btn-row" style="margin:0;flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="addRow()">+ Add</button>
          <button class="btn btn-danger btn-sm" id="del-sel-btn" onclick="deleteSelected()" disabled>âœ• Del</button>
          <button class="btn btn-secondary btn-icon" id="move-up-btn" onclick="moveSelected(-1)" disabled>â–²</button>
          <button class="btn btn-secondary btn-icon" id="move-dn-btn" onclick="moveSelected(1)" disabled>â–¼</button>
          <button class="btn btn-secondary btn-sm" onclick="autoSortLines()">â‡… Sort</button>
          <div class="divider"></div>
          <div class="undo-bar">
            <span class="undo-label">Table:</span>
            <button class="btn btn-secondary btn-icon" id="tbl-undo-btn" onclick="tableUndo()">â†©</button>
            <button class="btn btn-secondary btn-icon" id="tbl-redo-btn" onclick="tableRedo()">â†ª</button>
          </div>
          <div class="divider"></div>
          <button class="btn btn-warning btn-sm" onclick="saveToFile()">ğŸ’¾</button>
          <button class="btn btn-secondary btn-sm" onclick="loadFromFile()">ğŸ“‚</button>
        </div>
      </div>
      <div class="data-table-wrap" id="table-wrap">
        <table class="data-table">
          <thead><tr>
            <th class="sel-col"><input type="checkbox" id="check-all" class="row-check" onchange="toggleSelectAll(this.checked)"></th>
            <th style="width:28px;"></th>
            <th>Line</th><th>Dir</th><th>Deg</th><th>Min</th><th>Sec</th><th>Distance</th>
            <th style="width:48px;"></th>
          </tr></thead>
          <tbody id="table-body">
            <tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:28px;">No data â€” paste above or load sample.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="plot-pane">
    <div class="plot-pane-header">
      <span class="plot-pane-title">ğŸ“ Live Traverse Plot</span>
      <div style="flex:1;"></div>
      <button class="btn btn-secondary btn-icon" onclick="fitLivePlot()" title="Fit">âŠ¡</button>
      <button class="btn btn-secondary btn-icon" onclick="zoomLive(1.2)">ï¼‹</button>
      <button class="btn btn-secondary btn-icon" onclick="zoomLive(0.83)">ï¼</button>
      <button class="btn btn-primary btn-sm" onclick="switchTab('export')">âœï¸ Edit &amp; Export</button>
    </div>
    <div class="live-canvas-wrap">
      <canvas id="live-canvas"></canvas>
      <div class="plot-pane-info" id="live-info">Pan: drag Â· Zoom: scroll</div>
    </div>
  </div>
</div>

<!-- â•â• TAB 2: EXPORT & EDIT â•â• -->
<div class="panel" id="tab-export">

  <!-- DARK TOOLBAR -->
  <div class="exp-toolbar">
    <!-- Mode/Select group -->
    <div class="tb-group">
      <span class="tb-label">Navigate</span>
      <button class="tb-btn active" id="tool-pan" onclick="setTool('pan')" title="Pan canvas & drag labels">
        <span style="font-size:13px;">âœ¥</span> Pan <span id="sc-lbl-pan" style="font-size:9px;opacity:.55;margin-left:2px;">(V)</span>
      </button>
      <button class="tb-btn" id="tool-select" onclick="setTool('select')" title="Select & move objects">
        <span style="font-size:13px;">âŠ¹</span> Select <span id="sc-lbl-select" style="font-size:9px;opacity:.55;margin-left:2px;">(S)</span>
      </button>
      <button class="tb-btn" onclick="openShortcutModal()" title="Customize keyboard shortcuts" style="color:#888;font-size:13px;padding:5px 7px;">âš™</button>
    </div>

    <div class="tb-sep" style="height:32px;"></div>

    <!-- Draw group -->
    <div class="tb-group">
      <span class="tb-label">Draw</span>
      <button class="tb-btn" id="tool-text" onclick="setTool('text')" title="Place text (T)">
        <span style="font-size:14px;font-weight:800;">A</span> Text
      </button>
      <div style="display:inline-flex;align-items:center;gap:6px;">
        <button class="tb-btn" id="tool-line" onclick="setTool('line')" title="Draw straight line (L)" style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:13px;">â•±</span>
          <span>Line</span>
          <select id="tb-line-style" title="Line style" style="margin-left:6px;background:transparent;border:none;color:inherit;font-family:inherit;font-size:11px;">
            <option value="solid">â€” Solid</option>
            <option value="dashed">- - Dashed</option>
            <option value="dotted">Â· Â· Dotted</option>
          </select>
        </button>
      </div>
      <button class="tb-btn" id="tool-poly" onclick="setTool('poly')" title="Draw polyline / broken line (P)">
        <span style="font-size:13px;">âŒ’</span> Polyline
      </button>
    </div>

    <div class="tb-sep" style="height:32px;"></div>

    <!-- Snap -->
    <div class="tb-group">
      <span class="tb-label">Snapping</span>
      <button class="tb-btn" id="snap-btn" onclick="toggleSnap()" title="Snap to traverse points (G)">
        ğŸ§² <span id="snap-lbl">Off</span>
      </button>
    </div>

    <!-- Poly finish/cancel (only during poly drawing) -->
    <div class="tb-group" id="poly-actions" style="display:none;">
      <span class="tb-label">Polyline</span>
      <button class="tb-btn" onclick="finishPoly()" title="Finish polyline (Enter)" style="color:#7dd9a0;">âœ“ Finish</button>
      <button class="tb-btn" onclick="cancelPoly()" title="Cancel (Esc)" style="color:#e88;">âœ• Cancel</button>
    </div>

    <div class="tb-sep" style="height:32px;"></div>

    <!-- Edit history -->
    <div class="tb-group">
      <span class="tb-label">Canvas Edit</span>
      <button class="tb-btn" id="cedit-undo" onclick="ceditUndo()" disabled title="Undo canvas edit (Ctrl+Z)">â†© Undo</button>
      <button class="tb-btn" id="cedit-redo" onclick="ceditRedo()" disabled title="Redo canvas edit (Ctrl+Y)">â†ª Redo</button>
      <div class="tb-sep" style="height:20px;"></div>
      <button class="tb-btn" id="del-obj-btn" onclick="deleteSelectedObj()" disabled title="Delete selected (Del)" style="color:#e88;">ğŸ—‘ Del</button>
    </div>

    <div class="tb-sep" style="height:32px;"></div>

    <!-- View controls -->
    <div class="tb-group">
      <span class="tb-label">View</span>
      <button class="tb-btn" onclick="fitExport()" title="Fit to view">âŠ¡ Fit</button>
      <button class="tb-btn" onclick="zoomExp(1.15)" title="Zoom in">ï¼‹</button>
      <button class="tb-btn" onclick="zoomExp(0.87)" title="Zoom out">ï¼</button>
    </div>

    <!-- Export group â€” pushed to right -->
    <div class="tb-group" style="margin-left:auto;">
      <button class="tb-btn tb-btn-export" onclick="openPreview()" title="Full-screen preview">ğŸ” Preview</button>
      <button class="tb-btn tb-btn-export" onclick="copyExp()" title="Copy as PNG (transparent BG)">ğŸ“‹ Copy</button>
      <button class="tb-btn tb-btn-export" onclick="downloadExp()" title="Download PNG">â¬‡ PNG</button>
    </div>
  </div>

  <!-- TOOL PROPERTY STRIP (context sensitive) -->
  <div class="tool-props-strip" id="tool-props-strip">
    <!-- filled dynamically -->
  </div>

  <div class="exp-body">

    <!-- SIDEBAR -->
    <div class="exp-sidebar">
      <div class="sidebar-scroll">

        <!-- 1. Traverse -->
        <div class="acc" id="acc-traverse">
          <div class="acc-hdr" onclick="toggleAcc('acc-traverse')">
            <span class="acc-hdr-left"><span class="acc-hdr-icon">ğŸ“</span>Traverse Style</span>
            <span class="acc-arrow">â–¾</span>
          </div>
          <div class="acc-body">
            <div class="cr"><span class="cl">Line Color</span><input type="color" id="exp-line-color" value="#000000" oninput="renderExport()"></div>
            <div class="cr">
              <span class="cl">Thickness</span>
              <input type="range" id="exp-line-thick" min="0.5" max="10" step="0.5" value="2" oninput="syncR('exp-line-thick','exp-thick-val');renderExport()">
              <span class="cv" id="exp-thick-val">2</span>
            </div>
            <div class="toggle-row" onclick="toggleOpt('showDots')">
              <div class="toggle on" id="toggle-showDots"></div><span class="cl">Show Dots</span>
            </div>
            <div class="cr">
              <span class="cl">Dot Size</span>
              <input type="range" id="exp-dot-size" min="2" max="16" step="1" value="5" oninput="syncR('exp-dot-size','exp-dot-val');renderExport()">
              <span class="cv" id="exp-dot-val">5</span>
            </div>
          </div>
        </div>

        <!-- 2. Labels -->
        <div class="acc" id="acc-labels">
          <div class="acc-hdr" onclick="toggleAcc('acc-labels')">
            <span class="acc-hdr-left"><span class="acc-hdr-icon">ğŸ·</span>Point Labels</span>
            <span class="acc-arrow">â–¾</span>
          </div>
          <div class="acc-body">
            <div class="toggle-row" onclick="toggleOpt('showLabels')">
              <div class="toggle" id="toggle-showLabels"></div><span class="cl">Show Labels</span>
            </div>
            <div class="cr">
              <span class="cl">Font Size</span>
              <input type="range" id="exp-font-size" min="8" max="60" step="1" value="16" oninput="syncR('exp-font-size','exp-fs-val');renderExport()">
              <span class="cv" id="exp-fs-val">16</span>
            </div>
            <div class="cr"><span class="cl">Font Color</span><input type="color" id="exp-font-color" value="#000000" oninput="renderExport()"></div>
            <button class="btn btn-secondary btn-sm full-btn" onclick="autoPlaceLabels()" style="justify-content:center;">ğŸ”„ Auto Inside Polyline</button>
            <button class="btn btn-secondary btn-sm full-btn" onclick="resetLabelPositions()">â†º Reset Label Positions</button>
          </div>
        </div>

        <!-- 3. Drawing Tools -->
        <div class="acc" id="acc-draw">
          <div class="acc-hdr" onclick="toggleAcc('acc-draw')">
            <span class="acc-hdr-left"><span class="acc-hdr-icon">âœï¸</span>Drawing Options</span>
            <span class="acc-arrow">â–¾</span>
          </div>
          <div class="acc-body" style="gap:12px;">

            <!-- Hotkeys hint -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;padding:5px 7px;background:var(--surface);border-radius:5px;border:1px solid var(--border);">
              <span><b style="color:var(--accent2);">V</b> Pan/Labels</span>
              <span><b style="color:var(--accent2);">S</b> Select</span>
              <span><b style="color:var(--accent2);">T</b> Text</span>
              <span><b style="color:var(--accent2);">L</b> Line</span>
              <span><b style="color:var(--accent2);">P</b> Polyline</span>
              <span><b style="color:var(--accent2);">G</b> Snap toggle</span>
            </div>

            <!-- STROKE section -->
            <div class="draw-section">
              <div class="draw-section-title">â•± Stroke &amp; Lines</div>
              <div class="cr"><span class="cl">Color</span><input type="color" id="d-stroke" value="#000000" oninput="renderExport()"></div>
              <div class="cr">
                <span class="cl">Width</span>
                <input type="range" id="d-width" min="0.5" max="14" step="0.5" value="2" oninput="syncR('d-width','d-width-val');renderExport()">
                <span class="cv" id="d-width-val">2</span>
              </div>
              <div class="cr">
                <span class="cl">Style</span>
                <select class="ctrl-select" id="d-dash" onchange="renderExport()" style="flex:1;margin-left:6px;">
                  <option value="solid">â€” Solid</option>
                  <option value="dashed">- - Dashed</option>
                  <option value="dotted">Â·Â·Â· Dotted</option>
                </select>
              </div>
              <div class="cr">
                <span class="cl">Cap</span>
                <select class="ctrl-select" id="d-cap" onchange="renderExport()" style="flex:1;margin-left:6px;">
                  <option value="round">â¬¤ Round</option>
                  <option value="butt">| Flat</option>
                  <option value="square">â–ª Square</option>
                </select>
              </div>
              <div class="cr">
                <span class="cl">Arrow</span>
                <select class="ctrl-select" id="d-arrow" onchange="renderExport()" style="flex:1;margin-left:6px;">
                  <option value="none">None</option>
                  <option value="end">â†’ End</option>
                  <option value="start">â† Start</option>
                  <option value="both">â†” Both</option>
                </select>
              </div>
            </div>

            <!-- TEXT section -->
            <div class="draw-section">
              <div class="draw-section-title">T Text</div>
              <div class="cr"><span class="cl">Color</span><input type="color" id="d-text-color" value="#000000" oninput="renderExport()"></div>
              <div class="cr">
                <span class="cl">Size</span>
                <input type="range" id="d-font-size" min="8" max="72" step="1" value="18" oninput="syncR('d-font-size','d-fs-val');renderExport()">
                <span class="cv" id="d-fs-val">18</span>
              </div>
              <div class="cr">
                <span class="cl">Font</span>
                <select class="ctrl-select" id="d-font" onchange="renderExport()" style="flex:1;margin-left:6px;">
                  <option value="Oxanium">Oxanium</option>
                  <option value="Share Tech Mono">Mono</option>
                  <option value="Arial">Arial</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Times New Roman">Times</option>
                </select>
              </div>
              <div class="toggle-row" onclick="toggleBold()">
                <div class="toggle" id="toggle-bold"></div><span class="cl">Bold</span>
              </div>
            </div>

            <!-- OBJECT actions -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
              <button class="btn btn-danger btn-sm" id="del-obj-btn2" onclick="deleteSelectedObj()" disabled style="justify-content:center;">ğŸ—‘ Delete</button>
              <button class="btn btn-secondary btn-sm" onclick="clearAllObjs()" style="justify-content:center;">âœ• Clear All</button>
            </div>
          </div>
        </div>

        <!-- 4. Canvas Size -->
        <div class="acc" id="acc-canvas">
          <div class="acc-hdr" onclick="toggleAcc('acc-canvas')">
            <span class="acc-hdr-left"><span class="acc-hdr-icon">ğŸ–¼</span>Canvas &amp; Output</span>
            <span class="acc-arrow">â–¾</span>
          </div>
          <div class="acc-body">
            <div class="cr"><span class="cl">Width px</span><input type="number" id="exp-width" value="1200" min="400" max="4000" step="100" onchange="resizeExpCanvas()"></div>
            <div class="cr"><span class="cl">Height px</span><input type="number" id="exp-height" value="900" min="300" max="3000" step="100" onchange="resizeExpCanvas()"></div>
            <div class="cr"><span class="cl">Padding</span>
              <input type="range" id="exp-padding" min="20" max="250" step="10" value="80" oninput="syncR('exp-padding','exp-pad-val');renderExport()">
              <span class="cv" id="exp-pad-val">80</span>
            </div>
            <button class="btn btn-secondary btn-sm full-btn" onclick="fitExport()">âŠ¡ Fit to Canvas</button>
            <div style="height:1px;background:var(--border);margin:2px 0;"></div>
            <button class="btn btn-primary btn-sm full-btn" onclick="openPreview()">ğŸ” Full-Screen Preview</button>
            <button class="btn btn-secondary btn-sm full-btn" onclick="copyExp()">ğŸ“‹ Copy (Transparent BG)</button>
            <button class="btn btn-secondary btn-sm full-btn" onclick="downloadExp()">â¬‡ Download PNG</button>
          </div>
        </div>

      </div><!-- /sidebar-scroll -->
    </div><!-- /exp-sidebar -->

    <!-- CANVAS AREA -->
    <div class="exp-canvas-area">
      <div class="exp-canvas-wrap" id="exp-wrap">
        <canvas id="export-canvas"></canvas>
      </div>
      <div class="canvas-status">
        <span class="cs-item" id="cs-tool">âœ¥ Pan</span>
        <span class="cs-item" style="color:#3a3a3a;">â”‚</span>
        <span class="cs-item" id="cs-hint" style="color:#3a3a3a;font-size:9px;"></span>
        <span class="cs-item" style="color:#3a3a3a;margin-left:auto;">â”‚</span>
        <span class="cs-item" id="cs-pos" style="color:#3a3a3a;">x:â€” y:â€”</span>
        <span class="cs-item cs-snap" id="cs-snap" style="display:none;">â¬¡ SNAP ON</span>
        <span class="cs-item" id="cs-objs" style="color:#3a3a3a;margin-left:8px;"></span>
      </div>
    </div>

  </div><!-- /exp-body -->
</div><!-- /tab-export -->

</div><!-- /main -->

<!-- Floating text input -->
<input id="txt-overlay" type="text" placeholder="Type text, Enter to placeâ€¦">
<div class="snap-ring" id="snap-ring"></div>
<div class="toast" id="toast"></div>
<input type="file" id="file-input" accept=".json" style="display:none" onchange="handleFileLoad(event)">

<!-- SHORTCUT EDITOR MODAL -->
<div class="sc-modal" id="sc-modal">
  <div class="sc-panel">
    <div class="sc-header">
      <span class="sc-title">âŒ¨ Customize Shortcuts</span>
      <button class="sc-close" onclick="closeShortcutModal()">âœ•</button>
    </div>
    <div class="sc-body" id="sc-body">
      <!-- rows injected by JS -->
    </div>
    <div class="sc-footer">
      <button class="btn btn-secondary btn-sm" onclick="resetShortcuts()">â†º Reset Defaults</button>
      <button class="btn btn-primary btn-sm" onclick="closeShortcutModal()">âœ“ Done</button>
    </div>
  </div>
</div>

<!-- Preview modal -->
<div class="preview-modal" id="preview-modal">
  <div class="preview-bar">
    <span class="preview-title">ğŸ” Output Preview</span>
    <span id="preview-dims" style="font-size:10px;color:rgba(255,255,255,.45);font-family:'Share Tech Mono',monospace;"></span>
    <div style="flex:1;"></div>
    <button class="btn btn-secondary btn-sm" onclick="copyExp()">ğŸ“‹ Copy</button>
    <button class="btn btn-secondary btn-sm" onclick="downloadExp()">â¬‡ Download</button>
    <button class="btn btn-danger btn-sm" onclick="closePreview()">âœ• Close</button>
  </div>
  <div class="preview-bg" onclick="closePreview()">
    <canvas id="preview-canvas" onclick="event.stopPropagation()"></canvas>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SURVEY STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let surveyData=[];
let pasteHistory=[''],pasteHistIdx=0;
let tableHistory=[[]],tableHistIdx=0;
let labelPositions={};
let exportOpts={showLabels:true,showDots:false,autoInside:false};
let textareaZoom=1;
let drawBold=false;
let labelFontScale=1; // dynamic font scale based on traverse size
let lv={ox:0,oy:0,sc:1,drag:false,lx:0,ly:0};

// â”€â”€ SHORTCUT CONFIG â”€â”€
const DEFAULT_SHORTCUTS={pan:'v',select:'s',text:'t',line:'l',poly:'p',snap:'g'};
let shortcuts=Object.assign({},DEFAULT_SHORTCUTS);
const TOOL_META={
  pan:  {label:'âœ¥ Pan',     desc:'Pan canvas & drag point labels'},
  select:{label:'âŠ¹ Select', desc:'Select & move drawn objects'},
  text: {label:'A Text',    desc:'Place text on canvas'},
  line: {label:'â•± Line',    desc:'Draw a straight line'},
  poly: {label:'âŒ’ Polyline',desc:'Draw broken lines / polylines'},
  snap: {label:'ğŸ§² Snap',   desc:'Toggle snap to traverse points'},
};
let est={ox:0,oy:0,sc:1};
let _toS=null,_expPts=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let objects=[];          // all user-drawn objects
let ceditHistory=[[]], ceditIdx=0;
let nextObjId=1;
let currentTool='pan';
let snapEnabled=false;
let snapPt=null;         // current snap point {x,y,label}

// Interaction helpers
let iact={
  panning:false,lx:0,ly:0,
  dragLabel:null,dlbx:0,dlby:0,dlBase:null,
  resizing:false,resizeOrigX:0,resizeOrigW:0,
  // line drawing
  lineStart:null,
  // polyline
  polyPts:[],
  // select/move
  selId:null,
  moving:false,moveSX:0,moveSY:0,moveOrig:null,
  // text rotate
  rotating:false,rotOrigAngle:0,rotObjBase:0,
  // text placement
  textPending:null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(m,d=2200){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d);}
function syncR(i,v){const el=document.getElementById(v);if(el)el.textContent=document.getElementById(i).value;}
function switchTab(n){
  const ns=['input','export'];
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',ns[i]===n));
  document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',ns[i]===n));
  if(n==='input')setTimeout(renderLivePlot,40);
  if(n==='export'){
    // Compute max distance and set font size to double it
    let maxDist=1;
    if(surveyData.length>0){
      maxDist=Math.max(...surveyData.map(r=>r.dist||1));
    }
    const fontSize=Math.max(8,Math.min(60,Math.round(maxDist*2)));
    document.getElementById('exp-font-size').value=fontSize;
    syncR('exp-font-size','exp-fs-val');
    setTimeout(()=>{resizeExpCanvas();renderExport();autoPlaceLabels();},40);
  }
}
function toggleOpt(k){
  exportOpts[k]=!exportOpts[k];
  document.getElementById('toggle-'+k).classList.toggle('on',exportOpts[k]);
  previewDirty=true;
  renderExport();
}
function toggleBold(){
  drawBold=!drawBold;
  document.getElementById('toggle-bold').classList.toggle('on',drawBold);
}
function toggleAcc(id){document.getElementById(id).classList.toggle('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseEntry(tok,i){
  if(i>=tok.length)return null;
  const line=tok[i];
  if(!/^\d+-\d+$/.test(line))return null;
  const ns=tok[i+1]?.toUpperCase();
  if(ns!=='N'&&ns!=='S')return null;
  const deg=parseFloat(tok[i+2]);if(isNaN(deg))return null;
  const min=parseFloat(tok[i+3]);if(isNaN(min))return null;
  const t4=tok[i+4]?.toUpperCase();
  let sec=0,ew,ds,consumed;
  if(t4==='E'||t4==='W'){ew=t4;ds=tok[i+5];consumed=6;}
  else{sec=parseFloat(t4);if(isNaN(sec))return null;ew=tok[i+5]?.toUpperCase();if(ew!=='E'&&ew!=='W')return null;ds=tok[i+6];consumed=7;}
  const dist=parseFloat(ds);if(isNaN(dist))return null;
  return{line,dir:ns+' '+ew,deg,min,sec,dist,_c:consumed};
}
function parseRawText(text){
  const tok=text.trim().split(/\s+/).filter(t=>t.length);
  const raw=[];let i=0;
  while(i<tok.length){const e=parseEntry(tok,i);if(e){const{_c,...d}=e;raw.push(d);i+=_c;}else i++;}
  return sortTraversal(raw);
}
function sortTraversal(segs){
  if(!segs.length)return segs;
  const fmap=new Map(),aF=new Set(),aT=new Set();
  segs.forEach(s=>{const[f,t]=s.line.split('-');fmap.set(f,s);aF.add(f);aT.add(t);});
  let sp=null;for(const f of aF){if(!aT.has(f)){sp=f;break;}}
  if(!sp)sp=segs[0].line.split('-')[0];
  const out=[],vis=new Set();let c=sp;
  while(fmap.has(c)&&!vis.has(c)){const sg=fmap.get(c);out.push(sg);vis.add(c);c=sg.line.split('-')[1];}
  segs.forEach(s=>{if(!vis.has(s.line.split('-')[0]))out.push(s);});
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOMETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bearingToAz(dir,deg,min,sec){
  const d=(deg||0)+(min||0)/60+(sec||0)/3600;
  const[ns,ew]=dir.split(' ');
  if(ns==='N'&&ew==='E')return d;if(ns==='S'&&ew==='E')return 180-d;
  if(ns==='S'&&ew==='W')return 180+d;if(ns==='N'&&ew==='W')return 360-d;return d;
}
function computePoints(data){
  if(!data.length)return{};
  const pts={},fp=data[0].line.split('-')[0];pts[fp]={x:0,y:0};
  for(const s of data){
    const[fr,to]=s.line.split('-');if(!pts[fr])continue;
    const az=bearingToAz(s.dir,s.deg,s.min,s.sec),r=az*Math.PI/180;
    pts[to]={x:pts[fr].x+s.dist*Math.sin(r),y:pts[fr].y-s.dist*Math.cos(r)};
  }
  return pts;
}
function centroidOf(pts){
  const ks=Object.keys(pts);if(!ks.length)return{x:0,y:0};
  let sx=0,sy=0;ks.forEach(k=>{sx+=pts[k].x;sy+=pts[k].y;});
  return{x:sx/ks.length,y:sy/ks.length};
}
function makeToScreen(pts,W,H,pad,sc,ox,oy){
  const ks=Object.keys(pts);
  let mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;
  ks.forEach(k=>{mnX=Math.min(mnX,pts[k].x);mxX=Math.max(mxX,pts[k].x);mnY=Math.min(mnY,pts[k].y);mxY=Math.max(mxY,pts[k].y);});
  const rX=mxX-mnX||1,rY=mxY-mnY||1;
  const bs=Math.min((W-pad*2)/rX,(H-pad*2)/rY);
  return(x,y)=>({sx:(x-mnX)*bs*sc+pad+ox+(W-pad*2-rX*bs*sc)/2,sy:(y-mnY)*bs*sc+pad+oy+(H-pad*2-rY*bs*sc)/2});
}

// Compute mapping parameters used by makeToScreen so we can invert the mapping.
function computeMapParams(W,H,pad,sc,ox,oy){
  const pts=computePoints(surveyData);
  const ks=Object.keys(pts);
  let mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;
  ks.forEach(k=>{mnX=Math.min(mnX,pts[k].x);mxX=Math.max(mxX,pts[k].x);mnY=Math.min(mnY,pts[k].y);mxY=Math.max(mxY,pts[k].y);});
  const rX=mxX-mnX||1,rY=mxY-mnY||1;
  const bs=Math.min((W-pad*2)/rX,(H-pad*2)/rY)||1;
  const centerX=(W-pad*2 - rX*bs*sc)/2;
  const centerY=(H-pad*2 - rY*bs*sc)/2;
  return {mnX,mnY,rX,rY,bs,sc,ox,oy,pad,centerX,centerY};
}

function screenToWorld(sx,sy,params){
  return {
    x: params.mnX + ((sx - params.pad - params.ox - params.centerX) / (params.bs * params.sc)),
    y: params.mnY + ((sy - params.pad - params.oy - params.centerY) / (params.bs * params.sc))
  };
}

function worldToScreen(wx,wy,params){
  return {
    sx: (wx - params.mnX) * params.bs * params.sc + params.pad + params.ox + params.centerX,
    sy: (wy - params.mnY) * params.bs * params.sc + params.pad + params.oy + params.centerY
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PASTE UNDO/REDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function recordPasteHist(){const v=document.getElementById('raw-input').value;pasteHistory=pasteHistory.slice(0,pasteHistIdx+1);pasteHistory.push(v);pasteHistIdx=pasteHistory.length-1;updPasteUndoBtns();}
function pasteUndo(){if(pasteHistIdx<=0)return;pasteHistIdx--;document.getElementById('raw-input').value=pasteHistory[pasteHistIdx];updPasteUndoBtns();}
function pasteRedo(){if(pasteHistIdx>=pasteHistory.length-1)return;pasteHistIdx++;document.getElementById('raw-input').value=pasteHistory[pasteHistIdx];updPasteUndoBtns();}
function updPasteUndoBtns(){document.getElementById('paste-undo-btn').disabled=pasteHistIdx<=0;document.getElementById('paste-redo-btn').disabled=pasteHistIdx>=pasteHistory.length-1;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABLE UNDO/REDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pushTableHist(){tableHistory=tableHistory.slice(0,tableHistIdx+1);tableHistory.push(JSON.parse(JSON.stringify(surveyData)));tableHistIdx=tableHistory.length-1;updTableUndoBtns();}
function tableUndo(){if(tableHistIdx<=0)return;tableHistIdx--;surveyData=JSON.parse(JSON.stringify(tableHistory[tableHistIdx]));renderTable();renderLivePlot();updTableUndoBtns();showToast('â†© Undo');}
function tableRedo(){if(tableHistIdx>=tableHistory.length-1)return;tableHistIdx++;surveyData=JSON.parse(JSON.stringify(tableHistory[tableHistIdx]));renderTable();renderLivePlot();updTableUndoBtns();showToast('â†ª Redo');}
function updTableUndoBtns(){document.getElementById('tbl-undo-btn').disabled=tableHistIdx<=0;document.getElementById('tbl-redo-btn').disabled=tableHistIdx>=tableHistory.length-1;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS EDIT UNDO/REDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pushCedit(){ceditHistory=ceditHistory.slice(0,ceditIdx+1);ceditHistory.push(JSON.parse(JSON.stringify(objects)));ceditIdx=ceditHistory.length-1;updCeditBtns();}
function ceditUndo(){if(ceditIdx<=0)return;ceditIdx--;objects=JSON.parse(JSON.stringify(ceditHistory[ceditIdx]));iact.selId=null;updSelBtns2();renderExport();updCeditBtns();showToast('â†© Edit undo');}
function ceditRedo(){if(ceditIdx>=ceditHistory.length-1)return;ceditIdx++;objects=JSON.parse(JSON.stringify(ceditHistory[ceditIdx]));iact.selId=null;updSelBtns2();renderExport();updCeditBtns();showToast('â†ª Edit redo');}
function updCeditBtns(){
  document.getElementById('cedit-undo').disabled=ceditIdx<=0;
  document.getElementById('cedit-redo').disabled=ceditIdx>=ceditHistory.length-1;
}
function updSelBtns2(){
  const has=!!iact.selId;
  document.getElementById('del-obj-btn').disabled=!has;
  document.getElementById('del-obj-btn2').disabled=!has;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABLE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dragSrc=null;
function renderTable(){
  const tb=document.getElementById('table-body');
  document.getElementById('row-count').textContent=surveyData.length?`(${surveyData.length} lines)`:'';
  updSelBtns();
  if(!surveyData.length){tb.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:28px;">No data â€” paste above or load sample.</td></tr>';return;}
  tb.innerHTML='';
  surveyData.forEach((row,idx)=>{
    const tr=document.createElement('tr');tr.setAttribute('draggable','true');tr.dataset.idx=idx;
    if(row._sel)tr.classList.add('selected');
    tr.innerHTML=`<td style="text-align:center;"><input type="checkbox" class="row-check" ${row._sel?'checked':''} onchange="toggleRowSel(${idx},this.checked)"></td>
      <td><span class="drag-handle">â ¿</span></td>
      <td><input class="inline-edit" value="${row.line}" style="width:55px" onchange="fieldChange(${idx},'line',this.value)"></td>
      <td><select class="inline-edit" style="width:60px" onchange="fieldChange(${idx},'dir',this.value)">${['N E','N W','S E','S W'].map(d=>`<option ${row.dir===d?'selected':''}>${d}</option>`).join('')}</select></td>
      <td><input class="inline-edit" type="number" min="0" max="89" value="${row.deg}" style="width:46px" onchange="fieldChange(${idx},'deg',+this.value)"></td>
      <td><input class="inline-edit" type="number" min="0" max="59" value="${row.min}" style="width:46px" onchange="fieldChange(${idx},'min',+this.value)"></td>
      <td><input class="inline-edit" type="number" min="0" max="59" value="${row.sec}" style="width:46px" onchange="fieldChange(${idx},'sec',+this.value)"></td>
      <td><input class="inline-edit" type="number" step="0.001" value="${row.dist}" style="width:68px" onchange="fieldChange(${idx},'dist',+this.value)"></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(${idx})">âœ•</button></td>`;
    tr.addEventListener('dragstart',()=>{dragSrc=idx;tr.style.opacity='.4';});
    tr.addEventListener('dragend',()=>{tr.style.opacity='';document.querySelectorAll('#table-body tr').forEach(r=>r.classList.remove('drag-over'));});
    tr.addEventListener('dragover',e=>{e.preventDefault();document.querySelectorAll('#table-body tr').forEach(r=>r.classList.remove('drag-over'));tr.classList.add('drag-over');});
    tr.addEventListener('drop',e=>{e.preventDefault();if(dragSrc!==null&&dragSrc!==idx){const m=surveyData.splice(dragSrc,1)[0];surveyData.splice(idx,0,m);pushTableHist();renderTable();renderLivePlot();}});
    tb.appendChild(tr);
  });
  const allSel=surveyData.length>0&&surveyData.every(r=>r._sel);
  document.getElementById('check-all').checked=allSel;
  document.getElementById('check-all').indeterminate=!allSel&&surveyData.some(r=>r._sel);
}
function fieldChange(idx,f,v){surveyData[idx][f]=v;pushTableHist();renderLivePlot();}
function deleteRow(idx){surveyData.splice(idx,1);pushTableHist();renderTable();renderLivePlot();}
function addRow(){
  const last=surveyData.length?surveyData[surveyData.length-1].line.split('-')[1]:'1';
  const next=parseInt(last)+1;
  surveyData.push({line:`${last}-${next}`,dir:'N E',deg:0,min:0,sec:0,dist:1,_sel:false});
  pushTableHist();renderTable();renderLivePlot();
  const w=document.getElementById('table-wrap');if(w)setTimeout(()=>w.scrollTop=w.scrollHeight,30);
}
function toggleRowSel(idx,c){surveyData[idx]._sel=c;renderTable();}
function toggleSelectAll(c){surveyData.forEach(r=>r._sel=c);renderTable();}
function updSelBtns(){const h=surveyData.some(r=>r._sel);['del-sel-btn','move-up-btn','move-dn-btn'].forEach(id=>document.getElementById(id).disabled=!h);}
function deleteSelected(){surveyData=surveyData.filter(r=>!r._sel);pushTableHist();renderTable();renderLivePlot();}
function moveSelected(dir){
  const idx=surveyData.map((_,i)=>i).filter(i=>surveyData[i]._sel);if(!idx.length)return;
  if(dir===-1&&idx[0]===0)return;if(dir===1&&idx[idx.length-1]===surveyData.length-1)return;
  if(dir===1)idx.reverse();for(const i of idx){const s=i+dir;[surveyData[i],surveyData[s]]=[surveyData[s],surveyData[i]];}
  pushTableHist();renderTable();renderLivePlot();
}
function autoSortLines(){if(!surveyData.length){showToast('âš  No data');return;}surveyData.forEach((r,i)=>r.line=`${i+1}-${i+2}`);pushTableHist();renderTable();renderLivePlot();showToast('âœ“ Re-numbered');}
async function pasteFromClipboard(){
  try{
    const text=await navigator.clipboard.readText();
    if(!text.trim()){showToast('âš  Clipboard is empty');return;}
    document.getElementById('raw-input').value=text;
    recordPasteHist();parseAndLoad();
  }catch(e){showToast('âš  Clipboard access denied â€” paste manually',3200);}
}
function parseAndLoad(){const t=document.getElementById('raw-input').value.trim();if(!t){showToast('âš  No data');return;}const p=parseRawText(t);if(!p.length){showToast('âš  Could not parse');return;}p.forEach(r=>r._sel=false);surveyData=p;pushTableHist();renderTable();renderLivePlot();showToast(`âœ“ Loaded ${p.length} lines`);}
function loadSampleData(){document.getElementById('raw-input').value=`1-2\tS 75 38 E\t8.58\t8-9\tN 11 04 E\t17.03\n2-3\tS 14 27 W\t14.18\t9-1\tN 09 29 E\t9.25\n3-4\tS 73 16 E\t0.92\n4-5\tS 12 54 W\t4.49\n5-6\tS 47 28 E\t5.24\n6-7\tS 41 17 W\t6.25\n7-8\tN 72 30 W\t9.63`;recordPasteHist();parseAndLoad();}
function clearAll(){surveyData=[];document.getElementById('raw-input').value='';recordPasteHist();pushTableHist();renderTable();renderLivePlot();showToast('âœ“ Cleared');}
function saveToFile(){const c=surveyData.map(({_sel,...r})=>r);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(c,null,2)],{type:'application/json'}));a.download='traverse_data.json';a.click();showToast('âœ“ Saved');}
function loadFromFile(){document.getElementById('file-input').click();}
function handleFileLoad(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(Array.isArray(d)){d.forEach(r=>r._sel=false);surveyData=d;pushTableHist();renderTable();renderLivePlot();showToast(`âœ“ Loaded ${d.length} lines`);}}catch{showToast('âš  Invalid JSON');}};r.readAsText(f);e.target.value='';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE PLOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLivePlot(){
  const wrap=document.querySelector('.live-canvas-wrap'),cv=document.getElementById('live-canvas');
  if(!wrap||!cv)return;
  cv.width=wrap.clientWidth;cv.height=wrap.clientHeight;
  const W=cv.width,H=cv.height,ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  if(!surveyData.length){ctx.fillStyle='#aaa';ctx.font='14px Oxanium,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Parse & Load data to see the traverse.',W/2,H/2);return;}
  const pts=computePoints(surveyData),toS=makeToScreen(pts,W,H,44,lv.sc,lv.ox,lv.oy);
  ctx.strokeStyle='#1a4a2e';ctx.lineWidth=1.8;ctx.lineJoin='round';ctx.lineCap='round';ctx.beginPath();let first=true;
  for(const s of surveyData){const[fr,to]=s.line.split('-');const fp=pts[fr],tp=pts[to];if(!fp||!tp)continue;const{sx:fx,sy:fy}=toS(fp.x,fp.y),{sx:tx,sy:ty}=toS(tp.x,tp.y);if(first){ctx.moveTo(fx,fy);first=false;}ctx.lineTo(tx,ty);}
  ctx.stroke();
  Object.keys(pts).forEach(k=>{const{sx,sy}=toS(pts[k].x,pts[k].y);ctx.beginPath();ctx.arc(sx,sy,4,0,Math.PI*2);ctx.fillStyle='#1a4a2e';ctx.fill();ctx.fillStyle='#1a4a2e';ctx.font='bold 12px Oxanium,sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(k,sx,sy-7);});
  document.getElementById('live-info').textContent=`Scale: ${(lv.sc*100).toFixed(0)}% Â· Pan: drag Â· Zoom: scroll`;
}
function fitLivePlot(){lv.ox=0;lv.oy=0;lv.sc=1;renderLivePlot();}
function zoomLive(f){lv.sc*=f;renderLivePlot();}
function zoomLive(f){
  const cv=document.getElementById('live-canvas');
  if(!cv) { lv.sc*=f; renderLivePlot(); return; }
  const px=cv.width/2, py=cv.height/2;
  const pad=44; // same padding used in live plot
  const before=computeMapParams(cv.width,cv.height,pad,lv.sc,lv.ox,lv.oy);
  const world=screenToWorld(px,py,before);
  lv.sc*=f;
  const after=computeMapParams(cv.width,cv.height,pad,lv.sc,lv.ox,lv.oy);
  const newScr=worldToScreen(world.x,world.y,after);
  lv.ox += px - newScr.sx;
  lv.oy += py - newScr.sy;
  renderLivePlot();
}
function zoomTextarea(f){
  textareaZoom*=f;
  const ta=document.getElementById('raw-input');
  const zoomLabel=document.getElementById('textarea-zoom-level');
  if(ta){
    ta.style.fontSize=(12*textareaZoom)+'px';
  }
  if(zoomLabel){
    zoomLabel.textContent=(textareaZoom*100).toFixed(0)+'%';
  }
}
const liveCV=document.getElementById('live-canvas');
liveCV.addEventListener('mousedown',e=>{lv.drag=true;lv.lx=e.clientX;lv.ly=e.clientY;});
liveCV.addEventListener('mousemove',e=>{if(!lv.drag)return;lv.ox+=e.clientX-lv.lx;lv.oy+=e.clientY-lv.ly;lv.lx=e.clientX;lv.ly=e.clientY;renderLivePlot();});
liveCV.addEventListener('mouseup',()=>lv.drag=false);
liveCV.addEventListener('mouseleave',()=>lv.drag=false);
liveCV.addEventListener('wheel',e=>{e.preventDefault();lv.sc*=e.deltaY<0?1.1:0.91;renderLivePlot();},{passive:false});
window.addEventListener('resize',()=>{
  if(document.getElementById('tab-input').classList.contains('active'))renderLivePlot();
  if(document.getElementById('tab-export').classList.contains('active'))renderExport();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZABLE SPLIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const rs=document.getElementById('resizer'),lp=document.getElementById('input-pane');
  let resizing=false,sx=0,sw=0;
  rs.addEventListener('mousedown',e=>{resizing=true;sx=e.clientX;sw=lp.offsetWidth;rs.classList.add('dragging');document.body.style.cursor='col-resize';document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!resizing)return;const nw=Math.max(320,Math.min(sw+(e.clientX-sx),window.innerWidth-320));lp.style.width=nw+'px';lp.style.maxWidth=nw+'px';renderLivePlot();});
  document.addEventListener('mouseup',()=>{if(!resizing)return;resizing=false;rs.classList.remove('dragging');document.body.style.cursor='';document.body.style.userSelect='';});
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT: TRAVERSE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getExpOpts(){
  return{
    lineColor:document.getElementById('exp-line-color').value,
    lineThick:parseFloat(document.getElementById('exp-line-thick').value),
    fontSize:parseInt(document.getElementById('exp-font-size').value),
    fontColor:document.getElementById('exp-font-color').value,
    showDots:exportOpts.showDots,showLabels:exportOpts.showLabels,
    dotSize:parseInt(document.getElementById('exp-dot-size').value),
    padding:parseInt(document.getElementById('exp-padding').value),
  };
}
function autoPlaceLabels(){
  if(!surveyData.length)return;
  const pts=computePoints(surveyData),cen=centroidOf(pts),opts=getExpOpts();
  const W=parseInt(document.getElementById('exp-width').value)||1200,H=parseInt(document.getElementById('exp-height').value)||900;
  const toS=makeToScreen(pts,W,H,opts.padding,est.sc,est.ox,est.oy),{sx:cx,sy:cy}=toS(cen.x,cen.y);
  // Compute traverse bounding box to scale label offsets and font
  const ks=Object.keys(pts);
  let mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;
  ks.forEach(k=>{mnX=Math.min(mnX,pts[k].x);mxX=Math.max(mxX,pts[k].x);mnY=Math.min(mnY,pts[k].y);mxY=Math.max(mxY,pts[k].y);});
  const boxW=mxX-mnX||1,boxH=mxY-mnY||1;
  const traverseScale=Math.sqrt(boxW*boxH); // diagonal size of bounds
  // Compute dynamic font scale: scales between 0.7x and 1.5x based on traverse size
  labelFontScale = Math.max(0.7, Math.min(1.5, 0.8 + traverseScale * 0.15));
  const baseDist=opts.fontSize*1.3;
  Object.keys(pts).forEach(k=>{
    const{sx,sy}=toS(pts[k].x,pts[k].y);
    const vx=cx-sx,vy=cy-sy,len=Math.sqrt(vx*vx+vy*vy)||1;
    // Scale offset distance by traverse size so labels adjust to polyline dimensions
    const d=baseDist*(1+traverseScale*0.05);
    // store offsets in unscaled (base) units so drawTraverse can multiply by est.sc
    labelPositions[k]={dx:(vx/len)*d/(est.sc||1),dy:(vy/len)*d/(est.sc||1)};
  });
  showToast('âœ“ Labels placed inside');
  previewDirty=true;
  renderExport();
}
function resetLabelPositions(){labelPositions={};labelFontScale=1;renderExport();showToast('âœ“ Labels reset');}

function drawTraverse(ctx,pts,data,W,H,ox,oy,sc,opts){
  const pks=Object.keys(pts);if(!pks.length)return null;
  const toS=makeToScreen(pts,W,H,opts.padding,sc,ox,oy);
  ctx.strokeStyle=opts.lineColor;ctx.lineWidth=opts.lineThick;ctx.lineJoin='round';ctx.lineCap='round';ctx.beginPath();
  let first=true;
  for(const s of data){const[fr,to]=s.line.split('-');const fp=pts[fr],tp=pts[to];if(!fp||!tp)continue;const{sx:fx,sy:fy}=toS(fp.x,fp.y),{sx:tx,sy:ty}=toS(tp.x,tp.y);if(first){ctx.moveTo(fx,fy);first=false;}ctx.lineTo(tx,ty);}
  ctx.stroke();
  if(opts.showDots){pks.forEach(k=>{const{sx,sy}=toS(pts[k].x,pts[k].y);ctx.beginPath();ctx.arc(sx,sy,opts.dotSize,0,Math.PI*2);ctx.fillStyle=opts.lineColor;ctx.fill();});}
  if(opts.showLabels){const sfs=Math.max(6,opts.fontSize*sc*labelFontScale);ctx.font=`bold ${sfs}px Oxanium,sans-serif`;ctx.fillStyle=opts.fontColor;ctx.textAlign='center';ctx.textBaseline='middle';pks.forEach(k=>{const{sx,sy}=toS(pts[k].x,pts[k].y);const defN=-(opts.dotSize+opts.fontSize*0.7);const sdx=(labelPositions[k]?.dx??0)*sc,sdy=(labelPositions[k]?.dy??defN)*sc;ctx.fillText(k,sx+sdx,sy+sdy);});}
  return toS;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW USER OBJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDStyle(){
  const ds=document.getElementById('d-dash').value;
  return{
    stroke:document.getElementById('d-stroke').value,
    width:parseFloat(document.getElementById('d-width').value),
    dash:ds==='dashed'?[10,5]:ds==='dotted'?[2,5]:[],
    cap:document.getElementById('d-cap').value,
    arrow:document.getElementById('d-arrow').value,
    fontSize:parseInt(document.getElementById('d-font-size').value),
    fontFamily:document.getElementById('d-font').value,
    textColor:document.getElementById('d-text-color').value,
    bold:drawBold,
  };
}

// Binary-search font size that fills boxW pixels
function fitFontSize(text,ff,bold,boxW){
  if(!text||!boxW)return 12;
  const ctx=expCV.getContext('2d');
  let lo=4,hi=500;
  for(let i=0;i<18;i++){
    const mid=(lo+hi)/2;
    ctx.font=`${bold?'bold ':''}${mid}px "${ff}",sans-serif`;
    (ctx.measureText(text).width<=boxW)?lo=mid:hi=mid;
  }
  return Math.max(4,lo);
}

function renderObjects(ctx,objs,selId,ghostObj){
  const all=ghostObj?[...objs,ghostObj]:objs;
  for(const o of all){
    ctx.save();
    const sel=o.id&&o.id===selId;

    if(o.type==='line'||o.type==='poly'){
      const pts=o.type==='line'?[{x:o.x1,y:o.y1},{x:o.x2,y:o.y2}]:o.pts;
      if(pts.length<2){ctx.restore();continue;}
      ctx.strokeStyle=o.stroke||'#000';ctx.lineWidth=o.width||1;
      ctx.setLineDash(o.dash||[]);ctx.lineCap=o.cap||'round';ctx.lineJoin='round';
      if(sel){ctx.save();ctx.strokeStyle='rgba(74,144,226,.5)';ctx.lineWidth=(o.width||1)+6;ctx.setLineDash([]);ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);ctx.stroke();ctx.restore();}
      ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);ctx.stroke();
      if(o.arrow&&o.arrow!=='none'){
        const asz=o.arrowSz||14;ctx.fillStyle=o.stroke||'#000';ctx.setLineDash([]);
        if(o.arrow==='end'||o.arrow==='both')drawArrow(ctx,pts[pts.length-2],pts[pts.length-1],asz);
        if(o.arrow==='start'||o.arrow==='both')drawArrow(ctx,pts[1],pts[0],asz);
      }
      if(sel&&o.type==='poly'){ctx.fillStyle='rgba(74,144,226,.8)';pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();});}
      // endpoint handles for line
      if(sel&&o.type==='line'){
        ctx.fillStyle='rgba(74,144,226,.85)';
        [{x:o.x1,y:o.y1},{x:o.x2,y:o.y2}].forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();});
      }
    }
    else if(o.type==='text'){
      const ff=o.fontFamily||'Oxanium',bold=o.bold||false;
      let fs=o.fontSize||18;
      if(o.boxW&&o.text)fs=fitFontSize(o.text,ff,bold,o.boxW);
      ctx.font=`${bold?'bold ':''}${fs}px "${ff}",sans-serif`;
      const tw=o.boxW??ctx.measureText(o.text||'').width;
      const rot=o.rotation||0;

      ctx.save();
      ctx.translate(o.x+tw/2,o.y+fs/2);
      ctx.rotate(rot);
      ctx.fillStyle=o.textColor||'#000000';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(o.text||'',0,0);

      if(sel){
        const hw=tw/2+4,hh=fs/2+4;
        // Selection box
        ctx.strokeStyle='rgba(74,144,226,.85)';ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
        ctx.strokeRect(-hw,-hh,hw*2,hh*2);ctx.setLineDash([]);
        // Rotation handle (top-center)
        const rhx=0,rhy=-(hh+18);
        ctx.strokeStyle='rgba(74,144,226,.6)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(0,-hh);ctx.lineTo(rhx,rhy-6);ctx.stroke();
        ctx.beginPath();ctx.arc(rhx,rhy,6,0,Math.PI*2);
        ctx.fillStyle='rgba(74,144,226,.9)';ctx.fill();
        ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
        ctx.fillStyle='#fff';ctx.font='bold 8px sans-serif';
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('â†»',rhx,rhy+.5);
        // Resize handle (right-center, green)
        const rzx=hw+16,rzy=0;
        ctx.strokeStyle='rgba(74,144,226,.6)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(hw,0);ctx.lineTo(rzx-6,0);ctx.stroke();
        ctx.beginPath();ctx.arc(rzx,rzy,6,0,Math.PI*2);
        ctx.fillStyle='rgba(60,180,80,.9)';ctx.fill();
        ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
        ctx.fillStyle='#fff';ctx.font='bold 9px sans-serif';
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('â†”',rzx,rzy+.5);
      }
      ctx.restore();
    }
    ctx.restore();
  }
}
function drawArrow(ctx,from,to,sz){
  const angle=Math.atan2(to.y-from.y,to.x-from.x);
  ctx.save();ctx.translate(to.x,to.y);ctx.rotate(angle);
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-sz,-sz/2.5);ctx.lineTo(-sz,sz/2.5);ctx.closePath();ctx.fill();ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAN HELPER â€” shift all objects + labels by a pixel delta
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function panObjects(dx,dy){
  // Shift drawn objects
  for(const o of objects){
    if(o.type==='text'){o.x+=dx;o.y+=dy;}
    else if(o.type==='line'){o.x1+=dx;o.y1+=dy;o.x2+=dx;o.y2+=dy;}
    else if(o.type==='poly'){o.pts=o.pts.map(p=>({x:p.x+dx,y:p.y+dy}));}
  }
  // Shift point label offsets so they stay relative to their traverse point
  // (labelPositions stores dx/dy offsets from the on-screen traverse point,
  //  which itself moves with est.ox/est.oy â€” so labels move automatically.
  //  No action needed here for labelPositions.)
}
function renderExport(ghost=null){
  const cv=document.getElementById('export-canvas'),ctx=cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  if(!surveyData.length){ctx.fillStyle='#888';ctx.font='18px Oxanium,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('No data loaded.',cv.width/2,cv.height/2);return;}
  const pts=computePoints(surveyData);_expPts=pts;
  _toS=drawTraverse(ctx,pts,surveyData,cv.width,cv.height,est.ox,est.oy,est.sc,getExpOpts());
  renderObjects(ctx,objects,iact.selId,ghost);
  document.getElementById('cs-objs').textContent=objects.length?`${objects.length} obj${objects.length>1?'s':''}` :'';
}
function resizeExpCanvas(){
  const cv=document.getElementById('export-canvas');
  cv.width=parseInt(document.getElementById('exp-width').value)||1200;
  cv.height=parseInt(document.getElementById('exp-height').value)||900;
  est.ox=0;est.oy=0;est.sc=1;renderExport();
}
function fitExport(){
  // Move objects by the inverse of current pan offset, then reset
  panObjects(-est.ox,-est.oy);
  est.ox=0;est.oy=0;est.sc=1;
  renderExport();
}
function scaleObjectsFrom(px,py,f){
  for(const o of objects){
    if(o.type==='text'){o.x=px+(o.x-px)*f;o.y=py+(o.y-py)*f;if(o.boxW)o.boxW*=f;}
    else if(o.type==='line'){o.x1=px+(o.x1-px)*f;o.y1=py+(o.y1-py)*f;o.x2=px+(o.x2-px)*f;o.y2=py+(o.y2-py)*f;}
    else if(o.type==='poly'){o.pts=o.pts.map(p=>({x:px+(p.x-px)*f,y:py+(p.y-py)*f}));}
  }
}
function zoomExp(f){
  const cv=document.getElementById('export-canvas');
  if(!cv){return;}
  const px=cv.width/2, py=cv.height/2;
  const opts=getExpOpts();
  // Compute world point under the screen pivot, then change scale and recompute pan
  const before=computeMapParams(cv.width,cv.height,opts.padding,est.sc,est.ox,est.oy);
  const world=screenToWorld(px,py,before);
  // apply scale
  est.sc *= f;
  // after scaling, compute where that world point lands and shift est.ox/oy to keep it under pivot
  const after=computeMapParams(cv.width,cv.height,opts.padding,est.sc,est.ox,est.oy);
  const newScr=worldToScreen(world.x,world.y,after);
  est.ox += px - newScr.sx;
  est.oy += py - newScr.sy;
  // scale drawn objects coordinates so they stay anchored in canvas space
  scaleObjectsFrom(px,py,f);
  renderExport();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTool(t){
  commitText();
  if(currentTool==='poly'&&t!=='poly')cancelPoly();
  currentTool=t;
  document.querySelectorAll('.tb-btn[id^="tool-"]').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('tool-'+t);if(btn)btn.classList.add('active');
  document.getElementById('poly-actions').style.display=t==='poly'?'flex':'none';
  const cv=document.getElementById('export-canvas');
  const cursors={pan:'grab',select:'default',text:'crosshair',line:'crosshair',poly:'crosshair'};
  cv.style.cursor=cursors[t]||'default';
  const names={pan:'âœ¥ Pan / Labels',select:'âŠ¹ Select',text:'A Text',line:'â•± Line',poly:'âŒ’ Polyline'};
  const hints={
    pan:'Drag to pan Â· Scroll to zoom Â· Drag labels when "Show Labels" is on',
    select:'Click to select Â· Double-click text to edit Â· Drag to move Â· Del to delete',
    text:'Click on canvas to place text Â· Enter to confirm Â· Esc to cancel',
    line:'Click start Â· Click end to finish line',
    poly:'Click to add points Â· Double-click or Enter to finish Â· Esc to cancel',
  };
  document.getElementById('cs-tool').textContent=names[t]||t;
  const hint=document.getElementById('cs-hint');if(hint)hint.textContent=hints[t]||'';
  updateToolProps();
  renderExport();
}

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function selChange(key,val){
  if(!iact.selId)return;
  const o=objects.find(o=>o.id===iact.selId);if(!o)return;
  if(key==='text'){o.text=val;if(o.boxW){const tmpCtx=expCV.getContext('2d');tmpCtx.font=`${o.bold?'bold ':''}${o.fontSize||18}px "${o.fontFamily||'Oxanium'}",sans-serif`;o.boxW=Math.max(20,tmpCtx.measureText(val).width*1.05);}}
  else if(key==='textColor')o.textColor=val;
  else if(key==='fontSize'){const fs=Math.max(4,+val);const tmpCtx=expCV.getContext('2d');tmpCtx.font=`${o.bold?'bold ':''}${fs}px "${o.fontFamily||'Oxanium'}",sans-serif`;o.boxW=Math.max(20,tmpCtx.measureText(o.text||'W').width);o.fontSize=fs;}
  else if(key==='fontFamily')o.fontFamily=val;
  else if(key==='bold'){o.bold=val;if(o.boxW){const tmpCtx=expCV.getContext('2d');tmpCtx.font=`${val?'bold ':''}${o.fontSize||18}px "${o.fontFamily||'Oxanium'}",sans-serif`;o.boxW=Math.max(20,tmpCtx.measureText(o.text||'W').width);}}
  else if(key==='rotation')o.rotation=(+val%360)*Math.PI/180;
  else if(key==='stroke')o.stroke=val;
  else if(key==='lineWidth')o.width=Math.max(0.5,+val);
  else if(key==='dash')o.dash=val==='dashed'?[10,5]:val==='dotted'?[2,5]:[];
  else if(key==='arrow')o.arrow=val;
  else if(key==='cap')o.cap=val;
  pushCedit();renderExport();updateToolProps();
}

function updateToolProps(){
  const strip=document.getElementById('tool-props-strip');
  const t=currentTool;
  if(t==='text'){
    strip.className='tool-props-strip visible';
    strip.innerHTML=`<span class="tp-label">Text</span><div class="tp-val"><input class="tp-input" id="tp-txt" style="width:160px;" value="Label text" placeholder="Text to placeâ€¦"></div>`;
  } else if(t==='line'||t==='poly'){
    strip.className='tool-props-strip visible';
    strip.innerHTML=`<span class="tp-label">${t==='line'?'Line':'Polyline'}</span>
      <span class="tp-label">Arrow</span><div class="tp-val"><select class="tp-input" id="tp-arrow"><option value="none">None</option><option value="end">â†’ End</option><option value="start">â† Start</option><option value="both">â†” Both</option></select></div>
      <span class="tp-label">Tip size</span><div class="tp-val"><input class="tp-input" id="tp-arrsz" type="number" min="6" max="40" value="14" style="width:52px;"></div>
      ${t==='poly'?'<span style="color:#888;font-size:10px;margin-left:8px;">Double-click or Enter to finish</span>':''}`;
  } else if(t==='select'){
    const selObj=iact.selId?objects.find(o=>o.id===iact.selId):null;
    if(selObj&&selObj.type==='text'){
      const deg=Math.round(((selObj.rotation||0)*180/Math.PI+360)%360);
      const{fs}=getTextMetrics(selObj);
      const effFs=Math.round(fs);
      const fonts=['Oxanium','Share Tech Mono','Arial','Georgia','Times New Roman'];
      strip.className='tool-props-strip visible';
      strip.innerHTML=`
        <span class="tp-label">âœ Text</span>
        <div class="tp-val"><input class="tp-input" id="tp-sel-txt" style="width:120px;" value="${escHtml(selObj.text||'')}" oninput="selChange('text',this.value)"></div>
        <span class="tp-label">Color</span>
        <div class="tp-val"><input type="color" class="tp-input" style="width:26px;height:22px;padding:1px;" value="${selObj.textColor||'#000000'}" oninput="selChange('textColor',this.value)"></div>
        <span class="tp-label">Font</span>
        <div class="tp-val"><select class="tp-input" style="width:90px;" onchange="selChange('fontFamily',this.value)">${fonts.map(f=>`<option${selObj.fontFamily===f?' selected':''}>${escHtml(f)}</option>`).join('')}</select></div>
        <span class="tp-label">Size</span>
        <div class="tp-val"><input class="tp-input" type="number" min="4" max="400" value="${effFs}" style="width:48px;" onchange="selChange('fontSize',this.value)"></div>
        <div class="tp-val"><button class="tp-input" style="cursor:pointer;padding:2px 8px;font-weight:${selObj.bold?'bold':'normal'};" onclick="selChange('bold',!objects.find(o=>o.id===iact.selId)?.bold)">B</button></div>
        <span class="tp-label">RotÂ°</span>
        <div class="tp-val"><input class="tp-input" type="number" min="0" max="359" value="${deg}" style="width:46px;" oninput="selChange('rotation',this.value)"></div>
        <div class="tp-val" style="gap:3px;">
          <button class="tp-input" style="cursor:pointer;padding:2px 5px;" onclick="selChange('rotation',0)" title="Reset">â†º</button>
          <button class="tp-input" style="cursor:pointer;padding:2px 5px;" onclick="selChange('rotation',90)">90Â°</button>
        </div>
        <span style="color:#555;font-size:9px;margin-left:4px;">â†” drag to resize</span>`;
    } else if(selObj&&(selObj.type==='line'||selObj.type==='poly')){
      const dashId=(selObj.dash&&selObj.dash.length)?(selObj.dash[0]===2?'dotted':'dashed'):'solid';
      strip.className='tool-props-strip visible';
      strip.innerHTML=`
        <span class="tp-label">â•± ${selObj.type==='line'?'Line':'Poly'}</span>
        <span class="tp-label">Color</span>
        <div class="tp-val"><input type="color" class="tp-input" style="width:26px;height:22px;padding:1px;" value="${selObj.stroke||'#000000'}" oninput="selChange('stroke',this.value)"></div>
        <span class="tp-label">Width</span>
        <div class="tp-val"><input class="tp-input" type="number" min="0.5" max="30" step="0.5" value="${selObj.width||1}" style="width:46px;" onchange="selChange('lineWidth',this.value)"></div>
        <span class="tp-label">Style</span>
        <div class="tp-val"><select class="tp-input" style="width:75px;" onchange="selChange('dash',this.value)">
          <option value="solid"${dashId==='solid'?' selected':''}>â€” Solid</option>
          <option value="dashed"${dashId==='dashed'?' selected':''}>-- Dashed</option>
          <option value="dotted"${dashId==='dotted'?' selected':''}>Â·Â· Dotted</option>
        </select></div>
        <span class="tp-label">Arrow</span>
        <div class="tp-val"><select class="tp-input" style="width:75px;" onchange="selChange('arrow',this.value)">
          <option value="none"${!selObj.arrow||selObj.arrow==='none'?' selected':''}>None</option>
          <option value="end"${selObj.arrow==='end'?' selected':''}>â†’ End</option>
          <option value="start"${selObj.arrow==='start'?' selected':''}>â† Start</option>
          <option value="both"${selObj.arrow==='both'?' selected':''}>â†” Both</option>
        </select></div>`;
    } else {
      strip.className='tool-props-strip';
    }
  } else {
    strip.className='tool-props-strip';
  }
}

function setTextRotationDeg(deg){
  if(!iact.selId)return;
  const o=objects.find(o=>o.id===iact.selId);
  if(!o||o.type!=='text')return;
  o.rotation=(deg%360)*Math.PI/180;
  pushCedit();renderExport();updateToolProps();
}

function toggleSnap(){
  snapEnabled=!snapEnabled;
  document.getElementById('snap-lbl').textContent=snapEnabled?'On':'Off';
  document.getElementById('snap-btn').classList.toggle('active',snapEnabled);
  document.getElementById('cs-snap').style.display=snapEnabled?'inline':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SNAPPING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSnapPt(cx,cy){
  if(!snapEnabled||!_expPts||!_toS)return null;
  let best=null,bd=18;
  for(const k of Object.keys(_expPts)){
    const{sx,sy}=_toS(_expPts[k].x,_expPts[k].y);
    const d=Math.hypot(cx-sx,cy-sy);
    if(d<bd){bd=d;best={x:sx,y:sy,k};}
  }
  return best;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS COORDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const expCV=document.getElementById('export-canvas');
function cvXY(e){const r=expCV.getBoundingClientRect();return{x:(e.clientX-r.left)*(expCV.width/r.width),y:(e.clientY-r.top)*(expCV.height/r.height)};}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LABEL HIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function findLabel(cx,cy){
  if(!_expPts||!_toS)return null;
  const opts=getExpOpts(),sc=est.sc,sfs=opts.fontSize*sc;
  for(const k of Object.keys(_expPts)){
    const{sx,sy}=_toS(_expPts[k].x,_expPts[k].y);const defN=-(opts.dotSize+opts.fontSize*0.7);
    const sdx=(labelPositions[k]?.dx??0)*sc,sdy=(labelPositions[k]?.dy??defN)*sc;
    if(Math.abs(cx-(sx+sdx))<sfs&&Math.abs(cy-(sy+sdy))<sfs)return k;
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OBJECT HIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTextMetrics(o){
  const ctx=expCV.getContext('2d');
  const ff=o.fontFamily||'Oxanium',bold=o.bold||false;
  let fs=o.fontSize||18;
  if(o.boxW&&o.text)fs=fitFontSize(o.text,ff,bold,o.boxW);
  ctx.font=`${bold?'bold ':''}${fs}px "${ff}",sans-serif`;
  const tw=o.boxW??ctx.measureText(o.text||'').width;
  return{tw,fs,cx:o.x+tw/2,cy:o.y+fs/2};
}

function hitTestText(cx,cy,o){
  // Transform point into rotated text local space
  const {tw,fs,cx:ox,cy:oy}=getTextMetrics(o);
  const rot=o.rotation||0;
  const dx=cx-ox,dy=cy-oy;
  const lx=dx*Math.cos(-rot)-dy*Math.sin(-rot);
  const ly=dx*Math.sin(-rot)+dy*Math.cos(-rot);
  return Math.abs(lx)<=tw/2+6&&Math.abs(ly)<=fs/2+6;
}

function hitTestRotateHandle(cx,cy,o){
  // Handle is at top-center of selection box in rotated space
  const {tw,fs,cx:ox,cy:oy}=getTextMetrics(o);
  const rot=o.rotation||0;
  const hh=fs/2+4;
  const localHx=0, localHy=-(hh+18);
  // Convert handle local â†’ world
  const wx=ox+localHx*Math.cos(rot)-localHy*Math.sin(rot);
  const wy=oy+localHx*Math.sin(rot)+localHy*Math.cos(rot);
  return Math.hypot(cx-wx,cy-wy)<=10;
}

function hitTestResizeHandle(cx,cy,o){
  const{tw,fs,cx:ox,cy:oy}=getTextMetrics(o);
  const rot=o.rotation||0,hw=tw/2+4+16;
  const wx=ox+hw*Math.cos(rot),wy=oy+hw*Math.sin(rot);
  return Math.hypot(cx-wx,cy-wy)<=10;
}

function findObj(cx,cy){
  for(let i=objects.length-1;i>=0;i--){
    const o=objects[i];
    if(o.type==='text'){
      if(hitTestText(cx,cy,o))return o.id;
    } else if(o.type==='line'){
      if(ptNearSeg(cx,cy,o.x1,o.y1,o.x2,o.y2,8))return o.id;
    } else if(o.type==='poly'){
      for(let j=0;j<o.pts.length-1;j++){if(ptNearSeg(cx,cy,o.pts[j].x,o.pts[j].y,o.pts[j+1].x,o.pts[j+1].y,8))return o.id;}
    }
  }
  return null;
}
function ptNearSeg(px,py,x1,y1,x2,y2,thresh){
  const dx=x2-x1,dy=y2-y1,len2=dx*dx+dy*dy;
  if(!len2)return Math.hypot(px-x1,py-y1)<thresh;
  const t=Math.max(0,Math.min(1,((px-x1)*dx+(py-y1)*dy)/len2));
  return Math.hypot(px-(x1+t*dx),py-(y1+t*dy))<thresh;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXT OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _txtCtx=null; // {x,y,editId?}
function openTextOverlay(cx,cy,editObj){
  const ov=document.getElementById('txt-overlay');
  const r=expCV.getBoundingClientRect();
  const scX=r.width/expCV.width,scY=r.height/expCV.height;
  ov.style.left=(r.left+cx*scX)+'px';
  ov.style.top=(r.top+cy*scY-4)+'px';
  ov.style.fontSize=((parseInt(document.getElementById('d-font-size').value)||18)*scY)+'px';
  ov.style.fontFamily=document.getElementById('d-font').value;
  ov.value=editObj?editObj.text:(document.getElementById('tp-txt')?.value||'');
  ov.style.display='block';ov.focus();ov.select();
  _txtCtx=editObj?{x:cx,y:cy,editId:editObj.id}:{x:cx,y:cy};
}
function commitText(){
  const ov=document.getElementById('txt-overlay');
  if(ov.style.display!=='block'||!_txtCtx)return;
  const text=ov.value.trim();
  if(_txtCtx.editId){
    const o=objects.find(o=>o.id===_txtCtx.editId);
    if(o){o.text=text||o.text;pushCedit();}
  } else if(text){
    const s=getDStyle();
    const tmpCtx=expCV.getContext('2d');
    tmpCtx.font=`${s.bold?'bold ':''}${s.fontSize}px "${s.fontFamily}",sans-serif`;
    const natW=Math.max(s.fontSize*2,tmpCtx.measureText(text).width);
    objects.push({id:nextObjId++,type:'text',
      x:_txtCtx.x-natW/2,y:_txtCtx.y-s.fontSize/2,
      text,fontSize:s.fontSize,fontFamily:s.fontFamily,
      textColor:s.textColor,bold:s.bold,boxW:natW});
    pushCedit();
  }
  ov.style.display='none';ov.value='';
  const wasEditing=!!_txtCtx?.editId;_txtCtx=null;
  if(!wasEditing)setTool('pan');else{renderExport();updateToolProps();}
}
function cancelText(){
  const ov=document.getElementById('txt-overlay');
  ov.style.display='none';ov.value='';_txtCtx=null;
  setTool('pan');
}

document.getElementById('txt-overlay').addEventListener('keydown',e=>{
  if(e.key==='Enter'){e.preventDefault();commitText();}
  if(e.key==='Escape'){e.preventDefault();cancelText();}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLYLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finishPoly(){
  if(iact.polyPts.length>=2){
    const s=getDStyle();const arr=document.getElementById('tp-arrow')?.value||'none';const asz=parseInt(document.getElementById('tp-arrsz')?.value||14);
    objects.push({id:nextObjId++,type:'poly',pts:[...iact.polyPts],stroke:s.stroke,width:s.width,dash:s.dash,cap:s.cap,arrow:arr,arrowSz:asz});
    pushCedit();showToast(`âœ“ Polyline (${iact.polyPts.length} pts)`);
  }
  iact.polyPts=[];
  setTool('pan');
}
function cancelPoly(){iact.polyPts=[];setTool('pan');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE / CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteSelectedObj(){
  if(!iact.selId)return;
  objects=objects.filter(o=>o.id!==iact.selId);iact.selId=null;
  updSelBtns2();pushCedit();renderExport();showToast('âœ“ Deleted');
}
function clearAllObjs(){if(!objects.length)return;objects=[];iact.selId=null;updSelBtns2();pushCedit();renderExport();showToast('âœ“ Cleared all');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOUSE EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
expCV.addEventListener('mousedown',e=>{
  if(e.button!==0)return;
  commitText();
  const{x,y}=cvXY(e);
  const sp=getSnapPt(x,y);
  const cx=sp?.x??x,cy=sp?.y??y;

  if(currentTool==='pan'){
    if(exportOpts.showLabels){const lbl=findLabel(x,y);if(lbl){const opts=getExpOpts();const defN=-(opts.dotSize+opts.fontSize*0.7);iact.dragLabel=lbl;iact.dlbx=x;iact.dlby=y;iact.dlBase={dx:labelPositions[lbl]?.dx??0,dy:labelPositions[lbl]?.dy??defN};return;}}
    iact.panning=true;iact.lx=e.clientX;iact.ly=e.clientY;
  }
  else if(currentTool==='select'){
    const id=findObj(x,y);
    if(iact.selId){
      const selObj=objects.find(o=>o.id===iact.selId);
      // Resize handle (right-center of text box)
      if(selObj&&selObj.type==='text'&&hitTestResizeHandle(x,y,selObj)){
        const{tw}=getTextMetrics(selObj);
        iact.resizing=true;iact.resizeOrigX=x;iact.resizeOrigY=y;iact.resizeOrigW=selObj.boxW||tw;
        expCV.style.cursor='ew-resize';return;
      }
      // Rotate handle (top-center)
      if(selObj&&selObj.type==='text'&&hitTestRotateHandle(x,y,selObj)){
        const{cx:ox,cy:oy}=getTextMetrics(selObj);
        iact.rotating=true;iact.rotOrigAngle=Math.atan2(y-oy,x-ox);
        iact.rotObjBase=selObj.rotation||0;expCV.style.cursor='crosshair';return;
      }
    }
    objects.forEach(o=>delete o._sel);
    iact.selId=id||null;
    if(id){const o=objects.find(o=>o.id===id);if(o){iact.moving=true;iact.moveSX=cx;iact.moveSY=cy;iact.moveOrig=JSON.parse(JSON.stringify(o));}}
    updSelBtns2();updateToolProps();renderExport();
  }
  else if(currentTool==='text'){openTextOverlay(cx,cy,null);}
  else if(currentTool==='line'){iact.lineStart={x:cx,y:cy};}
  else if(currentTool==='poly'){
    if(e.detail===2){finishPoly();return;}
    iact.polyPts.push({x:cx,y:cy});renderExport();
  }
});

expCV.addEventListener('mousemove',e=>{
  const{x,y}=cvXY(e);
  const sp=getSnapPt(x,y);
  const cx=sp?.x??x,cy=sp?.y??y;

  // status
  document.getElementById('cs-pos').textContent=`x:${Math.round(x)} y:${Math.round(y)}`;

  // snap ring
  const ring=document.getElementById('snap-ring');
  if(sp&&snapEnabled){ring.style.display='block';ring.style.left=e.clientX+'px';ring.style.top=e.clientY+'px';}
  else ring.style.display='none';

  if(currentTool==='pan'){
    if(iact.dragLabel&&iact.dlBase){
      labelPositions[iact.dragLabel]={
        dx:iact.dlBase.dx+(x-iact.dlbx)/est.sc,
        dy:iact.dlBase.dy+(y-iact.dlby)/est.sc
      };
      renderExport();expCV.style.cursor='grabbing';return;
    }
    if(iact.panning){
      const ddx=e.clientX-iact.lx, ddy=e.clientY-iact.ly;
      est.ox+=ddx;est.oy+=ddy;
      iact.lx=e.clientX;iact.ly=e.clientY;
      panObjects(ddx,ddy);
      renderExport();expCV.style.cursor='grabbing';
    }
  }
  else if(currentTool==='select'){
    if(iact.resizing&&iact.selId){
      const o=objects.find(o=>o.id===iact.selId);
      if(o&&o.type==='text'){
        const rot=o.rotation||0,proj=(cx-iact.resizeOrigX)*Math.cos(rot)+(cy-iact.resizeOrigY)*Math.sin(rot);
        o.boxW=Math.max(20,iact.resizeOrigW+proj);
        renderExport();expCV.style.cursor='ew-resize';
      }
      return;
    }
    if(iact.rotating&&iact.selId){
      const o=objects.find(o=>o.id===iact.selId);
      if(o&&o.type==='text'){
        const{cx:ox,cy:oy}=getTextMetrics(o);
        const angle=Math.atan2(y-oy,x-ox);
        o.rotation=iact.rotObjBase+(angle-iact.rotOrigAngle);
        renderExport();expCV.style.cursor='crosshair';
      }
    }
    else if(iact.moving&&iact.selId){
      const o=objects.find(o=>o.id===iact.selId);if(!o)return;
      const dx=cx-iact.moveSX,dy=cy-iact.moveSY;
      if(o.type==='text'){o.x=iact.moveOrig.x+dx;o.y=iact.moveOrig.y+dy;}
      else if(o.type==='line'){o.x1=iact.moveOrig.x1+dx;o.y1=iact.moveOrig.y1+dy;o.x2=iact.moveOrig.x2+dx;o.y2=iact.moveOrig.y2+dy;}
      else if(o.type==='poly'){o.pts=iact.moveOrig.pts.map(p=>({x:p.x+dx,y:p.y+dy}));}
      renderExport();expCV.style.cursor='move';
    } else {
      // Hover cursor: change to rotate cursor when over handle
      if(iact.selId){
        const selObj=objects.find(o=>o.id===iact.selId);
        if(selObj&&selObj.type==='text'&&hitTestResizeHandle(x,y,selObj)){expCV.style.cursor='ew-resize';return;}
        if(selObj&&selObj.type==='text'&&hitTestRotateHandle(x,y,selObj)){expCV.style.cursor='crosshair';return;}
      }
      expCV.style.cursor='default';
    }
  }
  else if(currentTool==='line'&&iact.lineStart){
    const s=getDStyle();const arr=document.getElementById('tp-arrow')?.value||'none';
    renderExport({id:-1,type:'line',x1:iact.lineStart.x,y1:iact.lineStart.y,x2:cx,y2:cy,stroke:s.stroke,width:s.width,dash:s.dash,cap:s.cap,arrow:arr,arrowSz:14});
  }
  else if(currentTool==='poly'&&iact.polyPts.length>0){
    const s=getDStyle();
    renderExport({id:-1,type:'poly',pts:[...iact.polyPts,{x:cx,y:cy}],stroke:s.stroke,width:s.width,dash:s.dash,cap:s.cap,arrow:'none'});
  }
});

expCV.addEventListener('mouseup',e=>{
  if(e.button!==0)return;
  const{x,y}=cvXY(e);const sp=getSnapPt(x,y);const cx=sp?.x??x,cy=sp?.y??y;

  if(currentTool==='pan'){
    if(iact.dragLabel){
      // final label position already updated in mousemove
      // just reset drag label
      iact.dragLabel=null;expCV.style.cursor='grab';return;
    }
    iact.panning=false;expCV.style.cursor='grab';
  }
  else if(currentTool==='select'){
    if(iact.resizing){
      iact.resizing=false;pushCedit();updateToolProps();expCV.style.cursor='default';return;
    }
    if(iact.rotating){
      iact.rotating=false;pushCedit();
      expCV.style.cursor='default';
    } else if(iact.moving){
      const o=objects.find(o=>o.id===iact.selId);
      if(o&&iact.moveOrig){
        const moved=(o.type==='text'&&(o.x!==iact.moveOrig.x||o.y!==iact.moveOrig.y))||
          (o.type==='line'&&(o.x1!==iact.moveOrig.x1||o.y1!==iact.moveOrig.y1))||
          (o.type==='poly'&&o.pts[0]?.x!==iact.moveOrig.pts[0]?.x);
        if(moved)pushCedit();
      }
    }
    iact.moving=false;iact.moveOrig=null;
  }
  else if(currentTool==='line'&&iact.lineStart){
    if(Math.hypot(cx-iact.lineStart.x,cy-iact.lineStart.y)>4){
      const s=getDStyle();const arr=document.getElementById('tp-arrow')?.value||'none';const asz=parseInt(document.getElementById('tp-arrsz')?.value||14);
      objects.push({id:nextObjId++,type:'line',x1:iact.lineStart.x,y1:iact.lineStart.y,x2:cx,y2:cy,stroke:s.stroke,width:s.width,dash:s.dash,cap:s.cap,arrow:arr,arrowSz:asz});
      pushCedit();showToast('âœ“ Line added');
    }
    iact.lineStart=null;
    setTool('pan');
  }
});

expCV.addEventListener('mouseleave',()=>{
  iact.panning=false;iact.dragLabel=null;iact.rotating=false;iact.resizing=false;
  document.getElementById('snap-ring').style.display='none';
  if(currentTool==='pan')expCV.style.cursor='grab';
});

expCV.addEventListener('dblclick',e=>{
  if(currentTool==='poly'){finishPoly();return;}
  const{x,y}=cvXY(e);const id=findObj(x,y);
  if(id){
    const o=objects.find(o=>o.id===id);
    if(o&&o.type==='text'){
      // switch to select, select the object, open text editor
      if(currentTool!=='select'){setTool('select');}
      iact.selId=o.id;updSelBtns2();updateToolProps();renderExport();
      openTextOverlay(o.x,o.y,o);
    }
  }
});

expCV.addEventListener('wheel',e=>{
  e.preventDefault();
  if(e.buttons===4){
    // Middle button held + scroll â€” treat as extra pan
    panObjects(-e.deltaX,-e.deltaY);
    est.ox-=e.deltaX;est.oy-=e.deltaY;
  } else {
    zoomExp(e.deltaY<0?1.1:0.91);return;
  }
  renderExport();
},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MIDDLE MOUSE BUTTON â€” temporary pan while held
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _mmb={active:false,prevTool:'pan',lx:0,ly:0};

expCV.addEventListener('mousedown',e=>{
  if(e.button!==1)return;
  e.preventDefault(); // prevent autoscroll cursor
  _mmb.active=true;
  _mmb.prevTool=currentTool;
  _mmb.lx=e.clientX;_mmb.ly=e.clientY;
  // Temporarily force pan behaviour without changing the tool UI
  expCV.style.cursor='grabbing';
});

document.addEventListener('mousemove',e=>{
  if(!_mmb.active)return;
  const ddx=e.clientX-_mmb.lx, ddy=e.clientY-_mmb.ly;
  _mmb.lx=e.clientX;_mmb.ly=e.clientY;
  est.ox+=ddx;est.oy+=ddy;
  panObjects(ddx,ddy);
  renderExport();
});

document.addEventListener('mouseup',e=>{
  if(e.button!==1||!_mmb.active)return;
  _mmb.active=false;
  // Restore cursor to whatever the current tool uses
  const cursors={pan:'grab',select:'default',text:'crosshair',line:'crosshair',poly:'crosshair'};
  expCV.style.cursor=cursors[_mmb.prevTool]||'default';
});

expCV.addEventListener('contextmenu',e=>e.preventDefault());
// Prevent browser autoscroll when middle-clicking canvas
expCV.addEventListener('mousedown',e=>{if(e.button===1)e.preventDefault();});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  const inPaste=document.activeElement===document.getElementById('raw-input');
  const inTxt=document.activeElement===document.getElementById('txt-overlay');
  const inExp=document.getElementById('tab-export').classList.contains('active');
  const inScModal=document.getElementById('sc-modal').classList.contains('open');

  // Shortcut remapping takes priority
  if(_scListening&&inScModal){
    if(e.key==='Escape'){_scListening=null;renderScModal();return;}
    if(e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey){
      const k=e.key.toLowerCase();
      const conflict=Object.entries(shortcuts).find(([t,v])=>v===k&&t!==_scListening);
      if(conflict){showToast(`âš  "${k.toUpperCase()}" already used for ${TOOL_META[conflict[0]]?.label||conflict[0]}`,3000);return;}
      shortcuts[_scListening]=k;_scListening=null;
      renderScModal();updateShortcutLabels();showToast('âœ“ Remapped');
    }
    return;
  }

  if(e.key==='Escape'){
    closePreview();
    if(inScModal){closeShortcutModal();return;}
    if(inTxt){cancelText();return;}
    if(inExp){
      cancelPoly();cancelText();
      if(currentTool==='line'){iact.lineStart=null;setTool('pan');}
      renderExport();
    }
    return;
  }

  if(inTxt||inScModal)return;
  if(inPaste){
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();pasteUndo();}
    if((e.ctrlKey||e.metaKey)&&(e.key==='y'||e.key==='Y')){e.preventDefault();pasteRedo();}
    return;
  }
  if(inExp){
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();ceditUndo();}
    if((e.ctrlKey||e.metaKey)&&(e.key==='y'||e.key==='Y')){e.preventDefault();ceditRedo();}
    if((e.key==='Delete'||e.key==='Backspace')&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='SELECT'){e.preventDefault();deleteSelectedObj();}
    if(!e.ctrlKey&&!e.metaKey&&e.key.length===1){
      const k=e.key.toLowerCase();
      if(k===shortcuts.pan)setTool('pan');
      else if(k===shortcuts.select)setTool('select');
      else if(k===shortcuts.text)setTool('text');
      else if(k===shortcuts.line)setTool('line');
      else if(k===shortcuts.poly)setTool('poly');
      else if(k===shortcuts.snap)toggleSnap();
    }
    if(e.key==='Enter'&&currentTool==='poly'){e.preventDefault();finishPoly();}
  } else {
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();tableUndo();}
    if((e.ctrlKey||e.metaKey)&&(e.key==='y'||e.key==='Y')){e.preventDefault();tableRedo();}
  }
});

document.getElementById('raw-input').addEventListener('input',()=>{
  clearTimeout(document.getElementById('raw-input')._dbt);
  document.getElementById('raw-input')._dbt=setTimeout(recordPasteHist,600);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHORTCUT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _scListening=null;

function openShortcutModal(){
  _scListening=null;
  renderScModal();
  document.getElementById('sc-modal').classList.add('open');
}
function closeShortcutModal(){
  _scListening=null;
  document.getElementById('sc-modal').classList.remove('open');
  updateShortcutLabels();
}
function resetShortcuts(){
  shortcuts=Object.assign({},DEFAULT_SHORTCUTS);
  renderScModal();updateShortcutLabels();
  showToast('âœ“ Shortcuts reset to defaults');
}
function renderScModal(){
  const body=document.getElementById('sc-body');
  body.innerHTML='';
  for(const [tool,meta] of Object.entries(TOOL_META)){
    const row=document.createElement('div');
    row.className='sc-row';
    const info=document.createElement('div');
    info.innerHTML=`<div class="sc-tool-name">${meta.label}</div><div class="sc-tool-desc">${meta.desc}</div>`;
    const btn=document.createElement('button');
    btn.className='sc-key-btn'+(_scListening===tool?' listening':'');
    btn.id='sc-btn-'+tool;
    btn.textContent=_scListening===tool?'â€¦':shortcuts[tool].toUpperCase();
    btn.title='Click then press any key to remap';
    btn.onclick=()=>startListening(tool);
    row.appendChild(info);row.appendChild(btn);
    body.appendChild(row);
  }
  const inst=document.createElement('div');
  inst.style.cssText='font-size:9px;color:var(--text-dim);font-family:Share Tech Mono,monospace;text-align:center;padding:4px 0 2px;';
  inst.textContent='Click a key badge Â· Press any key Â· Esc to cancel';
  body.appendChild(inst);
}
function startListening(tool){
  _scListening=tool;
  renderScModal();
}
function updateShortcutLabels(){
  const panLbl=document.getElementById('sc-lbl-pan');
  const selLbl=document.getElementById('sc-lbl-select');
  if(panLbl)panLbl.textContent=`(${shortcuts.pan.toUpperCase()})`;
  if(selLbl)selLbl.textContent=`(${shortcuts.select.toUpperCase()})`;
  // Update hints in status bar if tool is active
  const hint=document.getElementById('cs-hint');
  if(hint&&currentTool)setTool(currentTool);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLEAN CANVAS (for export â€” no selection indicators)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCleanCanvas(){
  const src=document.getElementById('export-canvas');
  const off=document.createElement('canvas');off.width=src.width;off.height=src.height;
  const ctx=off.getContext('2d');
  const pts=computePoints(surveyData);
  const opts=getExpOpts();
  const W=off.width,H=off.height,pad=opts.padding;

  // Always render traverse at base (sc=1, ox=0, oy=0) so it fills the canvas cleanly
  _expPts=pts;
  _toS=drawTraverse(ctx,pts,surveyData,W,H,0,0,1,opts);

  // Objects are stored in the current zoomed canvas pixel space.
  // Convert them to base (sc=1, ox=0, oy=0) canvas space so they match the traverse above.
  const curP=computeMapParams(W,H,pad,est.sc,est.ox,est.oy);
  const basP=computeMapParams(W,H,pad,1,0,0);
  function cvToBase(px,py){
    const w=screenToWorld(px,py,curP);
    const b=worldToScreen(w.x,w.y,basP);
    return{x:b.sx,y:b.sy};
  }
  const sc=est.sc;
  const normObjs=objects.map(o=>{
    if(o.type==='text'){
      const bw=o.boxW||100,ff=o.fontFamily||'Oxanium',bl=o.bold||false;
      const fs=o.text?fitFontSize(o.text,ff,bl,bw):(o.fontSize||18);
      const{x:bx,y:by}=cvToBase(o.x+bw/2,o.y+fs/2);
      const bw2=bw/sc,fs2=o.text?fitFontSize(o.text,ff,bl,bw2):(o.fontSize||18);
      return{...o,x:bx-bw2/2,y:by-fs2/2,boxW:bw2};
    }else if(o.type==='line'){
      const{x:x1,y:y1}=cvToBase(o.x1,o.y1);
      const{x:x2,y:y2}=cvToBase(o.x2,o.y2);
      return{...o,x1,y1,x2,y2};
    }else if(o.type==='poly'){
      return{...o,pts:o.pts.map(p=>{const{x,y}=cvToBase(p.x,p.y);return{x,y};})};
    }
    return o;
  });
  renderObjects(ctx,normObjs,null,null);
  return off;
}

// Compute the pixel bounding box of all drawn content in BASE canvas space
// (sc=1, ox=0, oy=0 â€” matching what buildCleanCanvas renders).
// Returns {x,y,w,h} in canvas pixels, or null if nothing to show.
function getContentBounds(pad){
  pad=pad||48;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  function expand(x,y,r){r=r||0;minX=Math.min(minX,x-r);minY=Math.min(minY,y-r);maxX=Math.max(maxX,x+r);maxY=Math.max(maxY,y+r);}

  const cv=document.getElementById('export-canvas');
  const opts=getExpOpts();
  const pts=computePoints(surveyData);
  const W=cv.width,H=cv.height,pad0=opts.padding;
  // Base mapping (sc=1, ox=0, oy=0) â€” matches buildCleanCanvas
  const baseToS=makeToScreen(pts,W,H,pad0,1,0,0);

  // Traverse points at base
  if(pts){
    for(const k of Object.keys(pts)){
      const{sx,sy}=baseToS(pts[k].x,pts[k].y);
      expand(sx,sy,opts.showDots?opts.dotSize:0);
      if(opts.showLabels){
        const defN=-(opts.dotSize+opts.fontSize*0.7);
        // labelPositions stores normalized (sc=1) offsets â€” use directly at base
        const ndx=labelPositions[k]?.dx??0;
        const ndy=labelPositions[k]?.dy??defN;
        expand(sx+ndx,sy+ndy,opts.fontSize);
      }
    }
  }

  // Objects â€” convert from current canvas space to base canvas space (same as buildCleanCanvas)
  const curP=computeMapParams(W,H,pad0,est.sc,est.ox,est.oy);
  const basP=computeMapParams(W,H,pad0,1,0,0);
  function cvToBase(px,py){
    const w=screenToWorld(px,py,curP);const b=worldToScreen(w.x,w.y,basP);
    return{x:b.sx,y:b.sy};
  }
  const sc=est.sc;

  for(const o of objects){
    if(o.type==='text'){
      const bw=o.boxW||100,ff=o.fontFamily||'Oxanium',bl=o.bold||false;
      const fs=o.text?fitFontSize(o.text,ff,bl,bw):(o.fontSize||18);
      const{x:bx,y:by}=cvToBase(o.x+bw/2,o.y+fs/2);
      const bw2=bw/sc,fs2=o.text?fitFontSize(o.text,ff,bl,bw2):(o.fontSize||18);
      expand(bx,by,Math.hypot(bw2/2,fs2/2)+4);
    }else if(o.type==='line'){
      const{x:x1,y:y1}=cvToBase(o.x1,o.y1);
      const{x:x2,y:y2}=cvToBase(o.x2,o.y2);
      expand(x1,y1,(o.width||1)/2);expand(x2,y2,(o.width||1)/2);
    }else if(o.type==='poly'){
      const r=(o.width||1)/2;
      o.pts.forEach(p=>{const{x,y}=cvToBase(p.x,p.y);expand(x,y,r);});
    }
  }

  if(!isFinite(minX))return null;
  return{x:minX-pad,y:minY-pad,w:maxX-minX+pad*2,h:maxY-minY+pad*2};
}

// Render to a canvas cropped to content extents (used for preview).
function buildExtentsCanvas(){
  // Render full canvas first (also refreshes _toS / _expPts globals)
  const full=buildCleanCanvas();
  const bounds=getContentBounds(48);
  if(!bounds)return full;

  // Clamp crop rect to canvas dimensions
  const sx=Math.max(0,Math.floor(bounds.x));
  const sy=Math.max(0,Math.floor(bounds.y));
  const sw=Math.min(full.width-sx,Math.ceil(bounds.w+(bounds.x<0?bounds.x:0)));
  const sh=Math.min(full.height-sy,Math.ceil(bounds.h+(bounds.y<0?bounds.y:0)));
  if(sw<=0||sh<=0)return full;

  const crop=document.createElement('canvas');crop.width=sw;crop.height=sh;
  crop.getContext('2d').drawImage(full,sx,sy,sw,sh,0,0,sw,sh);
  return crop;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PREVIEW / COPY / DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPreview(){
  if(!surveyData.length){showToast('âš  No data');return;}
  // buildExtentsCanvas â†’ buildCleanCanvas both normalise to sc=1 internally,
  // so no need to touch est here.
  const off=buildExtentsCanvas();
  const pv=document.getElementById('preview-canvas');
  const W=off.width,H=off.height;
  const mW=window.innerWidth*.9,mH=(window.innerHeight-80)*.9;
  const sc=Math.min(mW/W,mH/H);
  pv.width=Math.round(W*sc);pv.height=Math.round(H*sc);
  const ctx=pv.getContext('2d');
  ctx.fillStyle='#fff';ctx.fillRect(0,0,pv.width,pv.height);
  ctx.drawImage(off,0,0,pv.width,pv.height);
  ctx.strokeStyle='rgba(0,0,0,.08)';ctx.lineWidth=1;ctx.strokeRect(.5,.5,pv.width-1,pv.height-1);
  document.getElementById('preview-dims').textContent=`${W} Ã— ${H} px (actual size)`;
  document.getElementById('preview-modal').classList.add('open');
  pv.onclick=e=>e.stopPropagation();
}
function closePreview(){document.getElementById('preview-modal').classList.remove('open');}
async function copyExp(){
  if(!surveyData.length){showToast('âš  No data');return;}
  buildCleanCanvas().toBlob(async blob=>{
    try{await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);showToast('âœ“ Copied (transparent BG)');}
    catch(err){showToast('âš  Copy failed: '+err.message,4000);}
  },'image/png');
}
function downloadExp(){
  if(!surveyData.length){showToast('âš  No data');return;}
  const a=document.createElement('a');a.download='traverse_plot.png';a.href=buildCleanCanvas().toDataURL('image/png');a.click();showToast('âœ“ Downloaded PNG');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  ['exp-line-thick:exp-thick-val','exp-dot-size:exp-dot-val','exp-font-size:exp-fs-val','exp-padding:exp-pad-val','d-width:d-width-val','d-font-size:d-fs-val']
    .forEach(pair=>{const[i,v]=pair.split(':');syncR(i,v);});
  Object.keys(exportOpts).forEach(k=>{const el=document.getElementById('toggle-'+k);if(el)el.classList.toggle('on',exportOpts[k]);});
  updPasteUndoBtns();updTableUndoBtns();updCeditBtns();
  setTool('pan');
  updateShortcutLabels();
  // initialize toolbar line-style dropdown to match sidebar control
  const tbLine=document.getElementById('tb-line-style');
  const sideDash=document.getElementById('d-dash');
  if(tbLine&&sideDash){
    tbLine.value = sideDash.value || 'solid';
    tbLine.addEventListener('change',()=>{sideDash.value=tbLine.value;previewDirty=true;renderExport();});
    // clicking the main area should open the tool; clicking the select should only change style
    const toolLineBtn=document.getElementById('tool-line');
    if(toolLineBtn){
      toolLineBtn.addEventListener('click',()=>setTool('line'));
    }
  }
});
</script>
<footer>
  <span class="trademark">Â© jdiniega_creations</span>
</footer>
</body>
</html>
